<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kredit İdarəetmə Sistemi (v3.1 - Düzəlişlərlə)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* CSS stilləri olduğu kimi qalır, heç bir dəyişiklik edilməyib */
        :root {
            --primary-color: #4a90e2; --secondary-color: #f5a623; --danger-color: #d0021b; --success-color: #7ed321; --info-color: #4abde2; --dark-color: #2c3e50; --dark-color-lighter: #34495e; --light-color: #ecf0f1; --background-color: #f4f7f6; --text-color: #333; --border-color: #e0e0e0; --shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { display: flex; background-color: var(--background-color); overflow-x: hidden; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInFromLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .sidebar { width: 280px; height: 100vh; background: linear-gradient(180deg, var(--dark-color) 0%, #1c2833 100%); color: var(--light-color); display: flex; flex-direction: column; padding: 20px 0; box-shadow: var(--shadow); position: fixed; left: 0; top: 0; transition: width 0.3s ease; animation: slideInFromLeft 0.5s ease-out; z-index: 100; }
        .sidebar-header { padding: 0 25px; margin-bottom: 30px; display: flex; align-items: center; }
        .sidebar-header .logo-icon { font-size: 28px; color: var(--primary-color); margin-right: 15px; }
        .sidebar-header h2 { font-weight: 600; font-size: 22px; color: var(--light-color); }
        .menu-list { list-style: none; flex-grow: 1; overflow-y: auto; }
        .menu-list > li > a { display: flex; align-items: center; padding: 15px 25px; color: var(--light-color); text-decoration: none; transition: all 0.3s ease; margin: 2px 15px; border-radius: 8px; font-weight: 500; cursor: pointer; }
        .menu-list > li > a:hover { background-color: var(--dark-color-lighter); }
        .menu-list .menu-icon { font-size: 18px; width: 25px; margin-right: 20px; text-align: center; }
        .arrow-icon { margin-left: auto; transition: transform 0.3s ease-in-out; }
        li.open > a .arrow-icon { transform: rotate(90deg); }
        .submenu { list-style: none; padding-left: 0; background-color: #1c2833; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        li.open > .submenu { max-height: 500px; }
        .submenu li a { display: flex; align-items: center; padding: 12px 20px 12px 55px; color: var(--light-color); text-decoration: none; font-size: 14px; transition: all 0.2s ease; }
        .submenu li a:hover { background-color: var(--dark-color-lighter) !important; }
        .submenu li a.active { color: var(--secondary-color); font-weight: 600; }
        .main-content { flex-grow: 1; margin-left: 280px; padding: 30px; transition: margin-left 0.3s ease; overflow-y: auto; height: 100vh; }
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .main-header h1, .main-header h2 { margin-bottom: 0; }
        .page { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        h1, h2 { color: var(--dark-color); margin-bottom: 20px; }
        h1 i, h2 i { color: var(--primary-color); }
        .collapsible-container { background-color: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; overflow: hidden; }
        .collapsible-header { padding: 15px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .collapsible-header h2 { margin: 0; font-size: 1.2em; }
        .collapsible-content { padding: 25px; max-height: 500px; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out; }
        .collapsible-container.collapsed .collapsible-content { max-height: 0; padding-top: 0; padding-bottom: 0; }
        .collapsible-header .toggle-icon { transition: transform 0.3s ease; }
        .collapsible-container.collapsed .toggle-icon { transform: rotate(-90deg); }
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .card { background-color: #fff; padding: 25px; border-radius: 8px; border: 1px solid #f0f0f0; display: flex; align-items: center; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .card .icon { font-size: 2.5rem; margin-right: 20px; padding: 15px; border-radius: 50%; color: #fff; }
        .card.card-customers .icon { background-color: var(--primary-color); }
        .card.card-debt .icon { background-color: var(--danger-color); }
        .card.card-overdue .icon { background-color: var(--secondary-color); }
        .card.card-paid .icon { background-color: var(--success-color); }
        .card .info h3 { font-size: 2rem; color: var(--dark-color); }
        .card .info p { font-size: 0.9rem; color: #777; }
        form { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .form-section-title { font-weight: 600; color: var(--primary-color); margin-top: 20px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .input-group { display: flex; align-items: center; gap: 5px; }
        .input-group select { flex: 0 0 80px; }
        .input-group input { flex: 1; }
        .form-group label { margin-bottom: 5px; font-weight: 500; font-size: 14px; }
        .form-group .checkbox-label { flex-direction: row; align-items: center; gap: 10px; cursor: pointer; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 16px; transition: border-color 0.3s, box-shadow 0.3s; background-color: #fff; }
        .form-group input[type="checkbox"] { width: auto; }
        .form-group input:read-only { background-color: #f1f1f1; cursor: not-allowed; font-weight: bold; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 5px rgba(74, 144, 226, 0.5); }
        #sifreler-form .form-group, #sifreler-form-edit .form-group, #magazaAdiFormu .form-group { max-width: 400px; }
        .password-feedback { font-size: 14px; margin-top: 5px; }
        .password-buttons-container { display: flex; flex-direction: column; gap: 10px; align-items: flex-start; }
        .submit-btn { background-color: var(--primary-color); color: #fff; border: none; padding: 12px 25px; font-size: 16px; font-weight: 600; border-radius: 5px; cursor: pointer; transition: background-color 0.3s, transform 0.2s; margin-top: 10px; display: inline-flex; align-items: center; gap: 8px; }
        .submit-btn:disabled { background-color: #aaa; cursor: not-allowed; }
        .submit-btn:hover:not(:disabled) { background-color: #3a7ac8; transform: translateY(-2px); }
        .export-btn { background-color: var(--success-color); }
        .export-btn:hover { background-color: #69b31c; }
        #searchBox { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 16px; }
        .table-container { background: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        td .customer-code { display: block; font-size: 12px; color: #777; }
        tbody tr { transition: background-color 0.3s ease; }
        tbody tr:hover { background-color: #f8f9fa; }
        .search-results-table td:last-child { width: 1%; }
        .search-results-table .select-customer-btn { padding: 5px 10px; font-size: 12px; background-color: var(--success-color); }
        #tarixceCedveli th, #tarixceCedveli td, #fakturaTarixcesiCedveli th, #fakturaTarixcesiCedveli td { padding: 8px 10px; font-size: 13px; text-align: center; vertical-align: middle; }
        #tarixceCedveli ul { margin: 0; padding: 0 0 0 10px; list-style-type: none; text-align: left; }
        #tarixceCedveli ul li { font-size: 12px; margin-bottom: 4px; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        #tarixceCedveli ul li:last-child { border-bottom: none; margin-bottom: 0; }
        #tarixceCedveli .action-btn { padding: 2px 5px; font-size: 11px; }
        thead { background-color: #f8f9fa; }
        th { font-weight: 600; color: var(--dark-color); cursor: pointer; user-select: none; }
        th .sort-icon { margin-left: 5px; opacity: 0.5; }
        th.sorted .sort-icon { opacity: 1; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; }
        .status-gecikir { background-color: var(--danger-color); }
        .status-bugun { background-color: var(--secondary-color); }
        .status-yaxinlasir { background-color: var(--success-color); }
        .status-normal { background-color: #ccc; }
        .status-nagd { background-color: var(--info-color); }
        .status-kredit { background-color: #6c757d; }
        .action-btn { padding: 6px 10px; border: none; border-radius: 5px; cursor: pointer; color: #fff; margin: 2px; font-size: 13px; transition: opacity 0.3s; }
        .action-btn:hover { opacity: 0.8; }
        .pay-btn { background-color: var(--primary-color); }
        .edit-btn { background-color: var(--secondary-color); }
        .delete-btn { background-color: var(--danger-color); }
        .details-btn { background-color: var(--info-color); }
        .view-details-btn { background-color: #6c757d; }
        .print-receipt-btn { background-color: var(--success-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.4s ease; }
        #cekModal, #nagdCekModal { z-index: 1050; }
        #confirmModal { z-index: 1060; }
        #passwordChangeModal { z-index: 1070; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border-radius: 8px; width: 90%; max-width: 700px; position: relative; box-shadow: 0 5px 25px rgba(0,0,0,0.2); animation: slideInDown 0.5s ease-out; }
        .modal-content.modal-sm { max-width: 500px; }
        .modal-content.modal-lg { max-width: 800px; }
        .modal-content.modal-confirm { max-width: 400px; text-align: center; }
        @keyframes slideInDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-btn { color: #aaa; position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s, transform 0.3s; }
        .close-btn:hover, .close-btn:focus { color: black; transform: rotate(90deg); }
        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 25px; }
        .details-item { padding: 8px 0; border-bottom: 1px solid #eee; }
        .details-item strong { color: #555; display: block; font-size: 13px; margin-bottom: 2px; }
        .details-item span { font-size: 16px; color: #333; }
        .selected-customer-info { background-color: #e9f3fe; border: 1px solid var(--primary-color); padding: 15px; border-radius: 5px; margin-top: 10px; margin-bottom: 15px; }
        .selected-customer-info p { margin: 0; }
        .selected-customer-info button { margin-left: 15px; padding: 2px 8px; font-size: 12px; background-color: var(--danger-color); }
        .printable-content { border: 1px dashed #333; padding: 20px; margin-bottom: 20px; }
        .printable-content h2 { text-align: center; margin-bottom: 15px; }
        .printable-content p { margin-bottom: 10px; font-size: 16px; }
        .printable-content hr { margin: 15px 0; }
        #muqavileBody h3 { margin-top: 20px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        #muqavileBody .muqavile-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        #muqavileBody .muqavile-row strong { color: #555; }
        #qrafikCedveli { width: 100%; margin-top: 15px; border-collapse: collapse; }
        #qrafikCedveli th, #qrafikCedveli td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        #qrafikCedveli thead { background-color: #f2f2f2; }
        .modal-actions { text-align: right; margin-top: 20px; }
        .modal-actions .submit-btn { margin-left: 10px; }
        #confirmModal .modal-content { padding-top: 40px; }
        #confirmModal .confirm-icon { width: 80px; height: 80px; border-radius: 50%; background-color: var(--secondary-color); color: white; font-size: 40px; display: flex; align-items: center; justify-content: center; margin: -70px auto 20px; box-shadow: 0 4px 10px rgba(245, 166, 35, 0.4); }
        #confirmModal h3 { font-size: 22px; margin-bottom: 10px; }
        #confirmModal p { margin-bottom: 25px; font-size: 16px; color: #666; }
        #confirmModal .modal-actions { justify-content: center; display: flex; gap: 15px; }
        #confirmModal .confirm-btn-yes { background-color: var(--success-color); }
        #confirmModal .confirm-btn-no { background-color: var(--danger-color); }
        .paid-row { background-color: #e8f5e9; }
        .partially-paid-row { background-color: #fffde7; }
        @media print { body * { visibility: hidden; } .sidebar, .modal-actions, .close-btn { display: none; } .printable-modal, .printable-modal *, .printable-content, .printable-content * { visibility: visible; } .printable-modal { position: absolute; left: 0; top: 0; width: 100%; height: 100%; margin: 0; padding: 0; background: none; overflow: visible !important; } .main-content { margin: 0 !important; padding: 0 !important; } .modal-content { box-shadow: none; border: none; margin: 0; max-width: 100%; padding: 5px; } #muqavileBody, #muqavileBody p { font-size: 10pt; line-height: 1.4; } #muqavileBody h2 { font-size: 14pt; } #muqavileBody h3 { font-size: 11pt; margin-top: 10px; } #qrafikCedveli th, #qrafikCedveli td { padding: 4px; font-size: 9pt; } }
    </style>
</head>
<body>
    <nav class="sidebar"> 
        <div class="sidebar-header">
            <i class="fas fa-cubes logo-icon"></i>
            <h2>Kredit Sistemi</h2>
        </div>
        <ul class="menu-list">
             <li>
                <a class="submenu-item" data-content="idarə-paneli-sehifesi">
                    <i class="fas fa-home menu-icon"></i><span class="menu-text">Əsas Səhifə</span>
                </a>
            </li>
            <li>
                <a>
                    <i class="fas fa-shopping-cart menu-icon"></i>
                    <span class="menu-text">Satış</span>
                    <i class="fas fa-chevron-right arrow-icon"></i>
                </a>
                <ul class="submenu">
                    <li><a href="#" class="submenu-item" data-content="yeni-kredit-sehifesi"><i class="fas fa-plus-circle menu-icon"></i> Yeni Kredit</a></li>
                    <li><a href="#" class="submenu-item" data-content="nagd-satis-sehifesi"><i class="fas fa-dollar-sign menu-icon"></i> Nağd Satış</a></li>
                </ul>
            </li>
            <li>
                <a>
                    <i class="fas fa-money-check-alt menu-icon"></i>
                    <span class="menu-text">Ödəniş</span>
                    <i class="fas fa-chevron-right arrow-icon"></i>
                </a>
                <ul class="submenu">
                    <li><a href="#" class="submenu-item" data-content="kassa-medaxil-sehifesi"><i class="fas fa-cash-register menu-icon"></i> Kassa mədaxil</a></li>
                    <li><a href="#" class="submenu-item" data-content="kassa-gun-sonu-sehifesi"><i class="fas fa-chart-line menu-icon"></i> Kassa Gün sonu</a></li>
                </ul>
            </li>
            <li>
                <a>
                    <i class="fas fa-users menu-icon"></i>
                    <span class="menu-text">Müştəri</span>
                    <i class="fas fa-chevron-right arrow-icon"></i>
                </a>
                <ul class="submenu">
                    <li><a href="#" class="submenu-item" data-content="musteri-bazasi-sehifesi"><i class="fas fa-database menu-icon"></i> Müştəri Bazası</a></li>
                </ul>
            </li>
            <li>
                <a>
                    <i class="fas fa-chart-pie menu-icon"></i>
                    <span class="menu-text">Hesabat</span>
                    <i class="fas fa-chevron-right arrow-icon"></i>
                </a>
                <ul class="submenu">
                    <li><a href="#" class="submenu-item" data-content="satis-hesabati-sehifesi"><i class="fas fa-file-invoice-dollar menu-icon"></i> Satış Hesabatı</a></li>
                    <li><a href="#" class="submenu-item" data-content="kassa-hesabati-sehifesi"><i class="fas fa-cash-register menu-icon"></i> Kassa Hesabatı</a></li>
                    <li><a href="#" class="submenu-item" data-content="bank-odenisleri-sehifesi"><i class="fas fa-university menu-icon"></i> Bank Ödənişləri</a></li>
                </ul>
            </li>
            <li>
                <a>
                    <i class="fas fa-cog menu-icon"></i>
                    <span class="menu-text">Tənzimləmələr</span>
                    <i class="fas fa-chevron-right arrow-icon"></i>
                </a>
                <ul class="submenu">
                    <li><a href="#" class="submenu-item" data-content="sifreler-sehifesi"><i class="fas fa-key menu-icon"></i> Şifrələr</a></li>
                    <li><a href="#" class="submenu-item" data-content="magaza-adi-sehifesi"><i class="fas fa-store menu-icon"></i> Mağaza Adı</a></li>
                </ul>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <div id="content-area">
            </div>
    </main>
    
    <div id="passwordChangeModal" class="modal"><div class="modal-content modal-sm"><span class="close-btn" id="closePasswordChangeModal">&times;</span><h2 id="passwordModalTitle" style="margin-bottom: 20px;">Şifrəni dəyiş</h2><div id="deletePassFormContainer" style="display: none;"><form id="sifreler-form" style="box-shadow: none; padding: 0;"><div class="form-group"><label for="delete-current-pass">Cari Şifrə</label><input type="password" id="delete-current-pass" required></div><div class="form-group"><label for="delete-new-pass">Yeni Şifrə</label><input type="password" id="delete-new-pass" required></div><button type="submit" data-pass-type="delete" class="submit-btn"><i class="fas fa-save"></i> Dəyişdir</button><p class="password-feedback" id="delete-feedback"></p></form></div><div id="editPassFormContainer" style="display: none;"><form id="sifreler-form-edit" style="box-shadow: none; padding: 0;"><div class="form-group"><label for="edit-current-pass">Cari Şifrə</label><input type="password" id="edit-current-pass" required></div><div class="form-group"><label for="edit-new-pass">Yeni Şifrə</label><input type="password" id="edit-new-pass" required></div><button type="submit" data-pass-type="edit" class="submit-btn"><i class="fas fa-save"></i> Dəyişdir</button><p class="password-feedback" id="edit-feedback"></p></form></div></div></div>
    <div id="detailsModal" class="modal"><div class="modal-content modal-lg"> <span class="close-btn" id="closeDetailsModal">&times;</span><div class="main-header" style="margin-bottom: 15px;"><h2 style="margin-bottom: 0;"><i class="fas fa-user-tag"></i> Müştəri Məlumatları</h2></div><h3 class="form-section-title">Şəxsi Məlumatlar</h3><div class="details-grid"><div class="details-item"><strong>Müştəri Kodu</strong><span id="detailsMusteriKodu"></span></div><div class="details-item"><strong>Ad, Soyad, Ata adı</strong><span id="detailsAdSoyad"></span></div><div class="details-item"><strong>Cins</strong><span id="detailsCins"></span></div><div class="details-item"><strong>FİN Kod</strong><span id="detailsFinKod"></span></div><div class="details-item"><strong>Vəsiqə Seriya və Nömrəsi</strong><span id="detailsVesiqe"></span></div><div class="details-item"><strong>Mobil Nömrələr</strong><span id="detailsNomreler"></span></div></div><h3 class="form-section-title">Faktura Tarixçəsi</h3><div class="table-container"><table id="fakturaTarixcesiCedveli"><thead><tr><th>Faktura ID</th><th>Tarix</th><th>Növ</th><th>Məhsul/Təsvir</th><th>Məbləğ / Qalıq Borc</th><th>Əməliyyat</th></tr></thead><tbody id="fakturaTarixcesiBody"></tbody></table></div></div></div>
    <div id="odenisModal" class="modal"><div class="modal-content modal-sm"><span class="close-btn" id="closeOdenisModal">&times;</span><h2><i class="fas fa-wallet"></i> Ödəniş Et</h2><form id="odenisFormu"><p><strong>Müştəri:</strong> <span id="modalMusteriAdi"></span></p><p><strong>Məhsul:</strong> <span id="modalMehsulAdi"></span></p><p><strong>Bu Ay Ödənilməlidir:</strong> <span id="modalAyliqOdenis"></span> AZN</p><input type="hidden" id="modalMusteriId"><input type="hidden" id="modalFakturaId"><input type="hidden" id="modalOdenisAyIndex"><div class="form-group"><label for="odenilenMebleg">Ödənilən Məbləğ (AZN)</label><input type="number" id="odenilenMebleg" step="0.01" required></div><div class="form-group"><label for="odenisUsulu">Ödəniş Üsulu</label><select id="odenisUsulu"><option value="Nağd">Nağd</option><option value="Kart">Kart ilə</option><option value="Kart/Nağd">Kart/Nağd</option></select></div><div id="mixedPaymentDiv" style="display: none;"><div class="form-row"><div class="form-group"><label for="odenisKartMebleg">Kart ilə (AZN)</label><input type="number" id="odenisKartMebleg" step="0.01" min="0" value="0"></div><div class="form-group"><label for="odenisNagdMebleg">Nağd (AZN)</label><input type="number" id="odenisNagdMebleg" step="0.01" min="0" value="0"></div></div></div><button type="submit" class="submit-btn"><i class="fas fa-dollar-sign"></i> Ödənişi Təsdiqlə</button></form></div></div>
    <div id="cekModal" class="modal printable-modal"><div class="modal-content modal-sm" id="cekContent"><span class="close-btn" id="closeCekModal">&times;</span><div id="cekBody" class="printable-content"><h2>KREDİT ÖDƏNİŞ QƏBZİ</h2><p><strong>Satıcı:</strong> <span id="cekSatici"></span></p><p><strong>Qəbz ID:</strong> <span id="cekId"></span></p><p><strong>Tarix:</strong> <span id="cekTarix"></span></p><hr><p><strong>Müştəri:</strong> <span id="cekMusteriAdi"></span></p><p><strong>Faktura üzrə Məhsul:</strong> <span id="cekMehsulAdi"></span></p><p><strong>Ödənilən Məbləğ:</strong> <span id="cekOdenenMebleg"></span> AZN</p><p><strong>Ödəniş Üsulu:</strong> <span id="cekOdenisUsulu"></span></p><hr><p><strong>Faktura üzrə Qalıq Borc:</strong> <span id="cekFakturaQaliqBorc"></span> AZN</p><p><strong>Ümumi Qalıq Borc:</strong> <span id="cekUmumiQaliqBorc"></span> AZN</p></div><div class="modal-actions"><button id="printCekBtn" class="submit-btn"><i class="fas fa-print"></i> Çap Et</button></div></div></div>
    <div id="nagdCekModal" class="modal printable-modal"><div class="modal-content modal-sm"><span class="close-btn" id="closeNagdCekModal">&times;</span><div id="nagdCekBody" class="printable-content"><h2>NAĞD SATIŞ QƏBZİ</h2><p><strong>Satıcı:</strong> <span id="nagdCekSatici"></span></p><p><strong>Qəbz ID:</strong> <span id="nagdCekId"></span></p><p><strong>Tarix:</strong> <span id="nagdCekTarix"></span></p><hr><p><strong>Müştəri:</strong> <span id="nagdCekMusteriAdi"></span></p><hr><p><strong>Məhsul:</strong> <span id="nagdCekMehsulAdi"></span></p><p><strong>Məbləğ:</strong> <span id="nagdCekOdenenMebleg"></span> AZN</p><p><strong>Ödəniş Üsulu:</strong> <span id="nagdCekOdenisUsulu"></span></p></div><div class="modal-actions"><button id="printNagdCekBtn" class="submit-btn"><i class="fas fa-print"></i> Çap Et</button></div></div></div>
    <div id="editModal" class="modal"><div class="modal-content modal-lg"><span class="close-btn" id="closeEditModal">&times;</span><h2><i class="fas fa-edit"></i> Məlumatlara Düzəliş Et</h2><form id="editMusteriFormu"><input type="hidden" id="editMusteriId"><h3 class="form-section-title">Şəxsi Məlumatlar (Dəyişdirilə bilər)</h3><div class="form-row"><div class="form-group"><label for="editAd">Ad</label><input type="text" id="editAd" required></div><div class="form-group"><label for="editSoyad">Soyad</label><input type="text" id="editSoyad" required></div><div class="form-group"><label for="editAtaAdi">Ata adı</label><input type="text" id="editAtaAdi" required></div></div><div class="form-row"><div class="form-group"><label for="editCins">Cins</label><select id="editCins" required><option value="Kişi">Kişi</option><option value="Qadın">Qadın</option></select></div><div class="form-group"><label for="editFinKod">FİN Kod</label><input type="text" id="editFinKod" required minlength="7" maxlength="7"></div><div class="form-group"><label for="editVesiqeSeria">Vəsiqə Seriya və Nömrəsi</label><div class="input-group"><select id="editVesiqeSeria"><option value="AZE">AZE</option><option value="AA">AA</option></select><input type="text" id="editVesiqeNomre" class="numeric-input" required pattern="\d{7}" maxlength="7"></div></div></div><div class="form-row"><div class="form-group"><label for="editMobil1">Əsas Mobil Nömrə</label><input type="tel" id="editMobil1" required></div><div class="form-group"><label for="editMobil2">Əlavə Nömrə 1</label><input type="tel" id="editMobil2"></div><div class="form-group"><label for="editMobil3">Əlavə Nömrə 2</label><input type="tel" id="editMobil3"></div></div><p style="font-size: 14px; color: #777;">*Kredit və satış məlumatları (fakturalar) dəyişdirilə bilməz. Onlara düzəliş etmək üçün ödəniş cədvəlindən istifadə edin.</p><button type="submit" class="submit-btn"><i class="fas fa-save"></i> Dəyişiklikləri Yadda Saxla</button></form></div></div>
    <div id="muqavileModal" class="modal printable-modal"><div class="modal-content modal-lg"><span class="close-btn" id="closeMuqavileModal">&times;</span><div id="muqavileBody" class="printable-content"><h2>Alqı-Satqı və Kredit Müqaviləsi</h2><p><strong>Tarix:</strong> <span id="muqavileTarix"></span></p><hr><h3>Tərəflər</h3><p><strong>Satıcı:</strong> <span id="muqavileSatici"></span></p><p><strong>Alıcı:</strong> <span id="muqavileMusteriAdi"></span> (<span id="muqavileMusteriKodu"></span>)</p><div class="muqavile-row"><p><strong>FİN Kod:</strong> <span id="muqavileFinKod"></span></p><p><strong>Vəsiqə:</strong> <span id="muqavileVesiqe"></span></p></div><hr><h3>Müqavilənin Predmeti</h3><div class="muqavile-row"><span><strong>Məhsul:</strong> <span id="muqavileMehsul"></span></span><span><strong>Kateqoriya:</strong> <span id="muqavileKateqoriya"></span></span></div><hr><h3>Kredit Şərtləri</h3><div class="muqavile-row"><span><strong>Nağd Qiymət:</strong> <span id="muqavileNagdQiymet"></span> AZN</span><span><strong>Kreditlə Qiymət:</strong> <span id="muqavileKreditQiymeti"></span> AZN</span></div><div class="muqavile-row"><span><strong>İlkin Ödəniş:</strong> <span id="muqavileIlkinOdenis"></span> AZN</span><span><strong>Kredit Müddəti:</strong> <span id="muqavileKreditMuddeti"></span> ay</span></div><div class="muqavile-row"><span><strong>Aylıq Ödəniş:</strong> <span id="muqavileAyliqOdenis"></span> AZN</span><span><strong>İlk Ödəniş Tarixi:</strong> <span id="muqavileIlkOdenisTarixi"></span></span></div><hr><h3>Ödəniş Cədvəli</h3><table id="qrafikCedveli"><thead><tr><th>Ay</th><th>Ödəniş Tarixi</th><th>Məbləğ (AZN)</th><th>Status</th></tr></thead><tbody id="muqavileQrafikBody"></tbody></table><br><div class="muqavile-row" style="margin-top: 40px;"><p><strong>Satıcı: _______________</strong></p><p><strong>Alıcı: _______________</strong></p></div></div><div class="modal-actions"><button id="printMuqavileBtn" class="submit-btn export-btn"><i class="fas fa-print"></i> Çap Et</button><button id="confirmMuqavileBtn" class="submit-btn"><i class="fas fa-check"></i> Təsdiqlə və Yadda Saxla</button></div></div></div>
    <div id="odenisTarixcesiModal" class="modal printable-modal"><div class="modal-content modal-lg"><span class="close-btn" id="closeTarixceModal">&times;</span><div class="main-header" style="margin-bottom: 15px;"><h2 id="tarixceModalTitle" style="margin-bottom: 0;"><i class="fas fa-history"></i> Ödəniş Qrafiki</h2></div><div id="tarixce-printable-area"><p><strong>Müştəri:</strong> <span id="tarixceMusteriAdi"></span></p><p><strong>Məhsul (Faktura):</strong> <span id="tarixceMehsulAdi"></span></p><div class="table-container"><table id="tarixceCedveli"><thead><tr id="tarixceCedveliHead"></tr></thead><tbody id="tarixceCedveliBody"></tbody></table></div></div><div class="modal-actions"><button id="tarixce-print-btn" class="submit-btn export-btn" style="margin-top: 0; display: none;"><i class="fas fa-print"></i> Çap Et</button></div></div></div>
    <div id="confirmModal" class="modal"><div class="modal-content modal-confirm"><div class="confirm-icon"><i class="fas fa-question"></i></div><h3 id="confirmTitle">Təsdiq</h3><p id="confirmText">Bu əməliyyatı təsdiqləyirsiniz?</p><div class="modal-actions"><button id="confirmBtnYes" class="submit-btn confirm-btn-yes"><i class="fas fa-check"></i> Bəli</button><button id="confirmBtnNo" class="submit-btn confirm-btn-no"><i class="fas fa-times"></i> Xeyr</button></div></div></div>


    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        
        // <<< BAŞLANĞIC KODU VƏ NAVİQASİYA >>>
        const mainMenuItems = document.querySelectorAll('.menu-list > li > a:not(.submenu-item)');
        const submenuItems = document.querySelectorAll('.submenu-item');
        const contentArea = document.getElementById('content-area');

        mainMenuItems.forEach(item => {
            item.addEventListener('click', function(event) {
                event.preventDefault();
                const parentLi = this.parentElement;
                if (parentLi.querySelector('.submenu')) {
                    document.querySelectorAll('.menu-list > li').forEach(li => {
                        if (li !== parentLi && li.classList.contains('open')) {
                            li.classList.remove('open');
                        }
                    });
                    parentLi.classList.toggle('open');
                }
            });
        });

        submenuItems.forEach(item => {
            item.addEventListener('click', function(event) {
                event.preventDefault();
                submenuItems.forEach(link => link.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.menu-list > li.active').forEach(li => li.classList.remove('active'));
                if (this.closest('.submenu')) {
                    this.closest('li.open').classList.add('active');
                } else {
                    this.parentElement.classList.add('active');
                }
                const contentId = this.dataset.content;
                updateContent(contentId);
            });
        });

        // Səhifə məzmunu şablonları (dəyişdirilməyib)
        const contentMap = {
            'idarə-paneli-sehifesi': { render: function(c){c.innerHTML = `
                        <section id="idarə-paneli-sehifesi" class="page">
                            <div class="main-header"><h1><i class="fas fa-home"></i> Əsas Səhifə</h1></div>
                            <div id="dashboard-collapsible" class="collapsible-container">
                                <div class="collapsible-header"><h2><i class="fas fa-database"></i> Ümumi baza məlumatı</h2><i class="fas fa-chevron-down toggle-icon"></i></div>
                                <div class="collapsible-content">
                                    <div class="dashboard-cards">
                                        <div class="card card-customers"><div class="icon"><i class="fas fa-users"></i></div><div class="info"><h3 id="total-customers">0</h3><p>Aktiv Müştəri</p></div></div>
                                        <div class="card card-debt"><div class="icon"><i class="fas fa-wallet"></i></div><div class="info"><h3 id="total-debt">0 AZN</h3><p>Ümumi Qalıq Borc</p></div></div>
                                        <div class="card card-overdue"><div class="icon"><i class="fas fa-exclamation-triangle"></i></div><div class="info"><h3 id="overdue-payments">0</h3><p>Gecikmədə olan</p></div></div>
                                        <div class="card card-paid"><div class="icon"><i class="fas fa-check-circle"></i></div><div class="info"><h3 id="paid-this-month">0 AZN</h3><p>Bu Ay Ödənilib</p></div></div>
                                    </div>
                                </div>
                            </div>
                        </section>`;},
                init: function(){
                    const d = document.getElementById('dashboard-collapsible');
                    if(d) d.querySelector('.collapsible-header').addEventListener('click', () => d.classList.toggle('collapsed'));
                    updateDashboard();
                }
            },
            'yeni-kredit-sehifesi': { render: function(c){c.innerHTML = `
                        <section id="yeni-kredit-sehifesi" class="page">
                            <div class="main-header"><h1><i class="fas fa-file-invoice-dollar"></i> Yeni Kredit Müraciəti</h1></div>
                            <form id="kreditFormu">
                                <input type="hidden" id="kreditMusteriId"><h3 class="form-section-title">Müştəri Seçimi</h3>
                                <div class="form-group"><label class="checkbox-label"><input type="checkbox" id="yeniKreditMusteriCheckbox" checked><span>Yeni müştəridir?</span></label></div>
                                <div id="movcudKreditMusteriFormu" style="display: none;">
                                    <div id="selectedKreditCustomerInfo" class="selected-customer-info" style="display:none;"></div>
                                    <div id="kreditCustomerSearchArea">
                                        <div class="form-row" style="align-items: flex-end;"><div class="form-group" style="flex-grow: 1;"><label for="kreditMusteriAxtarInput"><i class="fas fa-search"></i> Müştərini axtar (Ad, Kod, FİN, Telefon)</label><input type="text" id="kreditMusteriAxtarInput" placeholder="Axtarış üçün məlumat daxil edin..."></div><div class="form-group"><button type="button" id="kreditMusteriAxtarBtn" class="submit-btn" style="margin-top: 0;"><i class="fas fa-search"></i> Axtar</button></div></div>
                                        <div id="kreditMusteriAxtarNeticeleri" class="table-container" style="display: none;"><table class="search-results-table"><thead><tr><th>Müştəri</th><th>FİN Kod</th><th>Telefonlar</th><th>Seç</th></tr></thead><tbody id="kreditMusteriAxtarCedveli"></tbody></table></div>
                                    </div>
                                </div>
                                <div id="yeniKreditMusteriFormu">
                                    <h3 class="form-section-title">Müştəri Məlumatları</h3>
                                    <div class="form-row"><div class="form-group"><label for="ad"><i class="fas fa-user"></i> Ad</label><input type="text" id="ad" required></div><div class="form-group"><label for="soyad"><i class="fas fa-user"></i> Soyad</label><input type="text" id="soyad" required></div><div class="form-group"><label for="ataAdi"><i class="fas fa-user"></i> Ata adı</label><input type="text" id="ataAdi" required></div></div>
                                    <div class="form-row"><div class="form-group"><label for="cins"><i class="fas fa-venus-mars"></i> Cins</label><select id="cins" required><option value="Kişi">Kişi</option><option value="Qadın">Qadın</option></select></div><div class="form-group"><label for="finKod"><i class="fas fa-id-card"></i> FİN Kod</label><input type="text" id="finKod" required minlength="7" maxlength="7"></div><div class="form-group"><label for="vesiqeSeria">Vəsiqə Seriya və Nömrəsi</label><div class="input-group"><select id="vesiqeSeria"><option value="AZE">AZE</option><option value="AA">AA</option></select><input type="text" id="vesiqeNomre" class="numeric-input" required pattern="\\d{7}" maxlength="7" placeholder="1234567"></div></div></div>
                                    <div class="form-row"><div class="form-group"><label for="mobil1-nomre"><i class="fas fa-mobile-alt"></i> Əsas Mobil Nömrə</label><div class="input-group"><select id="mobil1-prefix"><option>050</option><option>051</option><option>055</option><option>010</option><option>070</option><option>077</option><option>099</option></select><input type="tel" id="mobil1-nomre" class="numeric-input" required pattern="\\d{7}" maxlength="7" placeholder="1234567"></div></div><div class="form-group"><label for="mobil2-nomre"><i class="fas fa-phone"></i> Əlavə Nömrə 1</label><div class="input-group"><select id="mobil2-prefix"><option>050</option><option>051</option><option>055</option><option>010</option><option>070</option><option>077</option><option>099</option></select><input type="tel" id="mobil2-nomre" class="numeric-input" pattern="\\d{7}" maxlength="7" placeholder="1234567"></div></div><div class="form-group"><label for="mobil3-nomre"><i class="fas fa-phone"></i> Əlavə Nömrə 2</label><div class="input-group"><select id="mobil3-prefix"><option>050</option><option>051</option><option>055</option><option>010</option><option>070</option><option>077</option><option>099</option></select><input type="tel" id="mobil3-nomre" class="numeric-input" pattern="\\d{7}" maxlength="7" placeholder="1234567"></div></div></div>
                                </div>
                                <h3 class="form-section-title">Kredit Məlumatları</h3>
                                <div class="form-row"><div class="form-group"><label for="mehsulAdi"><i class="fas fa-box"></i> Məhsulun Adı</label><input type="text" id="mehsulAdi" required></div><div class="form-group"><label for="mehsulKateqoriya"><i class="fas fa-tags"></i> Kateqoriya</label><select id="mehsulKateqoriya" required><option value="" disabled selected>Kateqoriya seçin</option><option value="Mobil telefon">Mobil telefon</option><option value="Böyük məişət texnikası">Böyük məişət texnikası</option><option value="Kiçik məişət texnikası">Kiçik məişət texnikası</option><option value="Aksesuar">Aksesuar</option><option value="Digər">Digər</option></select></div></div>
                                <div class="form-row"><div class="form-group"><label for="nagdQiymet"><i class="fas fa-money-bill-wave"></i> Nağd Qiyməti (AZN)</label><input type="number" id="nagdQiymet" required min="0"></div><div class="form-group"><label for="kreditMuddeti"><i class="fas fa-calendar-alt"></i> Kredit Müddəti (Ay)</label><select id="kreditMuddeti"><option value="3">3 Ay (+8%)</option><option value="6">6 Ay (+8%)</option><option value="9">9 Ay (+8%)</option><option value="12" selected>12 Ay (+15%)</option><option value="18">18 Ay (+20%)</option></select></div><div class="form-group"><label for="ilkinOdenis"><i class="fas fa-hand-holding-usd"></i> İlkin Ödəniş (AZN)</label><input type="number" id="ilkinOdenis" value="0" min="0"></div></div>
                                <div class="form-row" style="background: #f8f9fa; padding: 15px; border-radius: 5px; align-items: center;"><div class="form-group"><label for="kreditQiymeti"><i class="fas fa-credit-card"></i> Ümumi Kredit Məbləği (AZN)</label><input type="text" id="kreditQiymeti" readonly></div><div class="form-group"><label for="ayliqOdenis"><i class="fas fa-calendar-check"></i> Aylıq Ödəniş (AZN)</label><input type="text" id="ayliqOdenis" readonly></div></div>
                                <button type="submit" class="submit-btn"><i class="fas fa-file-signature"></i> Müqaviləyə Bax</button>
                            </form>
                        </section>`;},
                init: function(){
                    document.getElementById('kreditFormu').addEventListener('submit', handleKreditFormSubmit);
                    ['nagdQiymet', 'kreditMuddeti', 'ilkinOdenis'].forEach(id => document.getElementById(id).addEventListener('input', calculateKreditDetails));
                    document.getElementById('yeniKreditMusteriCheckbox').addEventListener('change', (e) => {
                        const isChecked = e.target.checked;
                        document.getElementById('yeniKreditMusteriFormu').style.display = isChecked ? 'block' : 'none';
                        document.getElementById('movcudKreditMusteriFormu').style.display = isChecked ? 'none' : 'block';
                        toggleKreditFormRequired(!isChecked);
                        if (!isChecked) { resetKreditFormCustomer(false); }
                    });
                    document.getElementById('kreditMusteriAxtarBtn').addEventListener('click', handleKreditMusteriSearch);
                    document.getElementById('kreditMusteriAxtarCedveli').addEventListener('click', handleSelectKreditMusteri);
                    document.querySelectorAll('.numeric-input').forEach(input => input.addEventListener('input', function(e) { this.value = this.value.replace(/[^0-9]/g, ''); }));
                    calculateKreditDetails();
                    toggleKreditFormRequired(false);
                }
            },
            'nagd-satis-sehifesi': { render: function(c){c.innerHTML = `
                       <section id="nagd-satis-sehifesi" class="page">
                            <div class="main-header"><h1><i class="fas fa-dollar-sign"></i> Nağd Satış</h1></div>
                            <form id="nagdFormu">
                                <input type="hidden" id="nagdMusteriId"><h3 class="form-section-title">Məhsul Məlumatları</h3>
                                <div class="form-row"><div class="form-group"><label for="nagdMehsulAdi"><i class="fas fa-box"></i> Məhsulun Adı</label><input type="text" id="nagdMehsulAdi" required></div><div class="form-group"><label for="nagdMehsulQiymeti"><i class="fas fa-money-bill-wave"></i> Satış Qiyməti (AZN)</label><input type="number" id="nagdMehsulQiymeti" required min="0"></div></div>
                                <h3 class="form-section-title">Müştəri Məlumatları</h3>
                                <div class="form-group"><label class="checkbox-label"><input type="checkbox" id="yeniMusteriCheckbox"><span>Yeni müştəri kimi qeyd et</span></label></div>
                                <div id="yeniMusteriFormu" style="display: none;">
                                    <div class="form-row"><div class="form-group"><label for="nagdAd"><i class="fas fa-user"></i> Ad</label><input type="text" id="nagdAd"></div><div class="form-group"><label for="nagdSoyad"><i class="fas fa-user"></i> Soyad</label><input type="text" id="nagdSoyad"></div><div class="form-group"><label for="nagdAtaAdi"><i class="fas fa-user"></i> Ata adı</label><input type="text" id="nagdAtaAdi"></div></div>
                                    <div class="form-row"><div class="form-group"><label for="nagdCins"><i class="fas fa-venus-mars"></i> Cins</label><select id="nagdCins"><option value="Kişi">Kişi</option><option value="Qadın">Qadın</option></select></div><div class="form-group"><label for="nagdFinKod"><i class="fas fa-id-card"></i> FİN Kod</label><input type="text" id="nagdFinKod" minlength="7" maxlength="7"></div><div class="form-group"><label for="nagdMobilNomre"><i class="fas fa-mobile-alt"></i> Mobil Nömrə</label><div class="input-group"><select id="nagdMobilPrefix"><option>050</option><option>051</option><option>055</option><option>010</option><option>070</option><option>077</option><option>099</option></select><input type="tel" id="nagdMobilNomre" class="numeric-input" pattern="\\d{7}" maxlength="7"></div></div></div>
                                </div>
                                <div id="movcudMusteriFormu">
                                    <div id="selectedCustomerInfo" class="selected-customer-info" style="display:none;"></div>
                                    <div id="customerSearchArea">
                                        <div class="form-row" style="align-items: flex-end;"><div class="form-group" style="flex-grow: 1;"><label for="nagdMusteriAxtarInput"><i class="fas fa-search"></i> Müştərini axtar (Ad, Kod, FİN, Telefon)</label><input type="text" id="nagdMusteriAxtarInput" placeholder="Axtarış üçün məlumat daxil edin..."></div><div class="form-group"><button type="button" id="nagdMusteriAxtarBtn" class="submit-btn" style="margin-top: 0;"><i class="fas fa-search"></i> Axtar</button></div></div>
                                        <div id="nagdMusteriAxtarNeticeleri" class="table-container" style="display: none;"><table class="search-results-table"><thead><tr><th>Müştəri</th><th>FİN Kod</th><th>Telefonlar</th><th>Seç</th></tr></thead><tbody id="nagdMusteriAxtarCedveli"></tbody></table></div>
                                    </div>
                                </div>
                                <h3 class="form-section-title">Ödəniş Məlumatları</h3>
                                <div class="form-row"><div class="form-group"><label for="nagdOdenisUsulu"><i class="fas fa-credit-card"></i> Ödəniş Üsulu</label><select id="nagdOdenisUsulu"><option value="Nağd">Nağd</option><option value="Kart ilə">Kart ilə</option><option value="Kart/Nağd">Kart/Nağd</option></select></div></div>
                                <div id="nagdMixedPaymentDiv" style="display: none;"><div class="form-row"><div class="form-group"><label for="nagdKartMebleg">Kart ilə (AZN)</label><input type="number" id="nagdKartMebleg" step="0.01" min="0" value="0"></div><div class="form-group"><label for="nagdNagdMebleg">Nağd (AZN)</label><input type="number" id="nagdNagdMebleg" step="0.01" min="0" value="0"></div></div></div>
                                <button type="submit" class="submit-btn"><i class="fas fa-check-circle"></i> Satışı Tamamla</button>
                            </form>
                        </section>`;},
                init: function(){
                    document.getElementById('nagdFormu').addEventListener('submit', handleNagdSubmit);
                    const y = document.getElementById('yeniMusteriCheckbox');
                    y.addEventListener('change', (e) => {
                        const i = e.target.checked;
                        document.getElementById('yeniMusteriFormu').style.display = i ? 'block' : 'none';
                        document.getElementById('movcudMusteriFormu').style.display = i ? 'none' : 'block';
                        resetNagdFormCustomer();
                    });
                    document.getElementById('nagdMusteriAxtarBtn').addEventListener('click', handleNagdMusteriSearch);
                    document.getElementById('nagdMusteriAxtarCedveli').addEventListener('click', handleSelectNagdMusteri);
                    const n = document.getElementById('nagdOdenisUsulu');
                    n.addEventListener('change', () => {
                        if (n.value === 'Kart/Nağd') { document.getElementById('nagdMixedPaymentDiv').style.display = 'block'; document.getElementById('nagdMehsulQiymeti').readOnly = true; } else { document.getElementById('nagdMixedPaymentDiv').style.display = 'none'; document.getElementById('nagdMehsulQiymeti').readOnly = false; }
                    });
                    ['nagdKartMebleg', 'nagdNagdMebleg'].forEach(id => { document.getElementById(id).addEventListener('input', () => { if (document.getElementById('nagdOdenisUsulu').value === 'Kart/Nağd') { const k = parseFloat(document.getElementById('nagdKartMebleg').value) || 0; const g = parseFloat(document.getElementById('nagdNagdMebleg').value) || 0; document.getElementById('nagdMehsulQiymeti').value = (k + g).toFixed(2); } }); });
                    document.querySelectorAll('.numeric-input').forEach(input => input.addEventListener('input', function(e) { this.value = this.value.replace(/[^0-9]/g, ''); }));
                    y.checked = false; y.dispatchEvent(new Event('change'));
                }
            },
            'kassa-medaxil-sehifesi': { render: function(c){c.innerHTML = `
                       <section id="kassa-medaxil-sehifesi" class="page">
                            <div class="main-header"><h1><i class="fas fa-cash-register"></i> Kassa mədaxil</h1></div>
                            <form id="kassaAxtarFormu">
                                <div class="form-row"><div class="form-group"><label for="kassaAxtarAd"><i class="fas fa-user"></i> Müştəri (Ad, Kod)</label><input type="text" id="kassaAxtarAd" placeholder="Ad və ya müştəri kodu daxil edin..."></div><div class="form-group"><label for="kassaAxtarFin"><i class="fas fa-id-card"></i> FİN Kod</label><input type="text" id="kassaAxtarFin" placeholder="FİN kodu daxil edin..."></div><div class="form-group"><label for="kassaAxtarTel"><i class="fas fa-phone"></i> Telefon Nömrəsi</label><input type="text" id="kassaAxtarTel" placeholder="Nömrəni daxil edin..."></div></div>
                                <button type="submit" class="submit-btn"><i class="fas fa-search"></i><span>Axtar</span></button>
                            </form>
                            <div id="kassaAxtarNeticeleri" class="table-container search-results-table" style="display: none;"><table><thead><tr><th>Müştəri</th><th>Məhsul (Faktura)</th><th>Qalıq Borc</th><th>Növbəti Ödəniş</th><th>Əməliyyat</th></tr></thead><tbody id="kassaAxtarCedveli"></tbody></table></div>
                        </section>`;},
                init: function(){ document.getElementById('kassaAxtarFormu').addEventListener('submit', handleKassaSearch); document.getElementById('kassaAxtarCedveli').addEventListener('click', handleTableActions); }
            },
            'kassa-gun-sonu-sehifesi': { render: function(c){c.innerHTML = `
                       <section id="kassa-gun-sonu-sehifesi" class="page">
                            <div class="main-header"><h1><i class="fas fa-chart-line"></i> Kassa Gün Sonu Hesabatı</h1></div>
                            <div class="dashboard-cards" style="margin-bottom: 25px;">
                                <div class="card card-paid"><div class="icon"><i class="fas fa-money-bill-wave"></i></div><div class="info"><h3 id="gunSonuNagdCemi">0.00 AZN</h3><p>Nağd Mədaxil</p></div></div>
                                <div class="card card-customers"><div class="icon"><i class="far fa-credit-card"></i></div><div class="info"><h3 id="gunSonuKartCemi">0.00 AZN</h3><p>Kart Mədaxil</p></div></div>
                                <div class="card card-debt"><div class="icon"><i class="fas fa-wallet"></i></div><div class="info"><h3 id="gunSonuUmumiCemi">0.00 AZN</h3><p>Ümumi Mədaxil</p></div></div>
                            </div>
                        </section>`;},
                init: function(){ renderCurrentDayReport(); }
            },
            'musteri-bazasi-sehifesi': { render: function(c){c.innerHTML = `
                        <section id="musteri-bazasi-sehifesi" class="page">
                            <div class="main-header"><h1><i class="fas fa-database"></i> Müştəri Bazası</h1></div>
                            <input type="text" id="searchBox" placeholder="Ada, soyada, koda və ya FİN-ə görə axtar...">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th data-sort="status">Status</th>
                                            <th data-sort="ad">Müştəri <i class="fas fa-sort sort-icon"></i></th>
                                            <th data-sort="ayliqOdenis">Növbəti Ödəniş <i class="fas fa-sort sort-icon"></i></th>
                                            <th data-sort="qaliqBorc">Ümumi Qalıq Borc <i class="fas fa-sort sort-icon"></i></th>
                                            <th data-sort="novbetiOdenisTarixi">Ən Yaxın Ödəniş Tarixi <i class="fas fa-sort sort-icon"></i></th>
                                            <th>Əməliyyatlar</th>
                                        </tr>
                                    </thead>
                                    <tbody id="musteriCedveli"></tbody>
                                </table>
                            </div>
                        </section>`;},
                init: function(){
                    document.getElementById('searchBox').addEventListener('keyup', () => renderMusteriler());
                    document.getElementById('musteriCedveli').addEventListener('click', handleTableActions);
                    document.querySelectorAll('#musteri-bazasi-sehifesi thead th').forEach(th => { if(th.dataset.sort) th.addEventListener('click', handleSort) });
                    renderMusteriler();
                }
            },
            'satis-hesabati-sehifesi': { render: function(c){c.innerHTML = `
                        <section class="page"><div class="main-header"><h1><i class="fas fa-file-invoice-dollar"></i> Satış Hesabatı</h1></div>
                        <form id="satisHesabatiFormu"><div class="form-row"><div class="form-group"><label for="satisHesabatiBaslamaTarixi">Başlama Tarixi</label><input type="date" id="satisHesabatiBaslamaTarixi" required></div><div class="form-group"><label for="satisHesabatiBitmeTarixi">Bitmə Tarixi</label><input type="date" id="satisHesabatiBitmeTarixi" required></div></div><button type="submit" class="submit-btn"><i class="fas fa-filter"></i> Filterlə</button></form>
                        <div class="table-container" style="margin-top: 20px;"><table><thead><tr><th>Faktura ID</th><th>Tarix</th><th>Müştəri Adı</th><th>Məbləğ (AZN)</th><th>Ödəniş Üsulu</th></tr></thead><tbody id="satisHesabatiCedveli"></tbody></table></div></section>`;},
                init: function(){ document.getElementById('satisHesabatiFormu').addEventListener('submit', handleSatisHesabatiFilter); setDefaultDatesAndFilter('satisHesabatiBaslamaTarixi', 'satisHesabatiBitmeTarixi', handleSatisHesabatiFilter); }
            },
            'kassa-hesabati-sehifesi': { render: function(c){c.innerHTML = `
                        <section class="page"><div class="main-header"><h1><i class="fas fa-cash-register"></i> Kassa Hesabatı</h1></div>
                        <form id="kassaHesabatiFormu"><div class="form-row"><div class="form-group"><label for="kassaHesabatiBaslamaTarixi">Başlama Tarixi</label><input type="date" id="kassaHesabatiBaslamaTarixi" required></div><div class="form-group"><label for="kassaHesabatiBitmeTarixi">Bitmə Tarixi</label><input type="date" id="kassaHesabatiBitmeTarixi" required></div><div class="form-group"><label for="kassaHesabatiOdenisUsulu">Ödəniş Üsulu</label><select id="kassaHesabatiOdenisUsulu"><option value="Hamisi">Hamısı</option><option value="Nağd">Nağd</option><option value="Kart">Kart</option><option value="Kart/Nağd">Kart/Nağd</option></select></div></div><button type="submit" class="submit-btn"><i class="fas fa-filter"></i> Filterlə</button></form>
                        <div class="table-container" style="margin-top: 20px;"><table><thead><tr><th>Ödəniş ID</th><th>Tarix</th><th>Müştəri Adı</th><th>Məhsul (Faktura)</th><th>Məbləğ (AZN)</th><th>Ödəniş Üsulu</th></tr></thead><tbody id="kassaHesabatiCedveli"></tbody></table></div></section>`;},
                init: function(){ document.getElementById('kassaHesabatiFormu').addEventListener('submit', handleKassaHesabatiFilter); setDefaultDatesAndFilter('kassaHesabatiBaslamaTarixi', 'kassaHesabatiBitmeTarixi', handleKassaHesabatiFilter); }
            },
            'bank-odenisleri-sehifesi': { render: function(c){c.innerHTML = `
                        <section class="page"><div class="main-header"><h1><i class="fas fa-university"></i> Bank Ödənişləri</h1></div>
                        <form id="bankOdenisleriFormu"><div class="form-row"><div class="form-group"><label for="bankOdenisleriTarix">Tarix seçin</label><input type="date" id="bankOdenisleriTarix" required></div></div><button type="submit" class="submit-btn"><i class="fas fa-eye"></i> Göstər</button></form>
                        <div class="dashboard-cards" style="margin-top: 25px;"><div class="card card-customers"><div class="icon"><i class="far fa-credit-card"></i></div><div class="info"><h3 id="bankOdenisleriCemi">0.00 AZN</h3><p>Seçilmiş Gün üzrə Kart Mədaxili</p></div></div></div></section>`;},
                init: function(){ document.getElementById('bankOdenisleriFormu').addEventListener('submit', handleBankOdenisleriFilter); const t = new Date().toISOString().split('T')[0]; document.getElementById('bankOdenisleriTarix').value = t; handleBankOdenisleriFilter(); }
            },
            'sifreler-sehifesi': { render: function(c){c.innerHTML = `
                        <section class="page"><div class="main-header"><h1><i class="fas fa-key"></i> Şifrələrin İdarə Olunması</h1></div>
                        <div class="password-buttons-container">
                            <button id="showDeletePassFormBtn" class="submit-btn"><i class="fas fa-trash-alt"></i> Silmə Şifrəsini Dəyiş</button>
                            <button id="showEditPassFormBtn" class="submit-btn" style="background-color: var(--secondary-color);"><i class="fas fa-edit"></i> Düzəliş Şifrəsini Dəyiş</button>
                        </div></section>`;},
                init: function(){
                    document.getElementById('showDeletePassFormBtn').addEventListener('click', () => { document.getElementById('passwordModalTitle').textContent = "Silmə Şifrəsini Dəyiş"; document.getElementById('deletePassFormContainer').style.display = 'block'; document.getElementById('editPassFormContainer').style.display = 'none'; document.getElementById('passwordChangeModal').style.display = 'block'; });
                    document.getElementById('showEditPassFormBtn').addEventListener('click', () => { document.getElementById('passwordModalTitle').textContent = "Düzəliş Şifrəsini Dəyiş"; document.getElementById('deletePassFormContainer').style.display = 'none'; document.getElementById('editPassFormContainer').style.display = 'block'; document.getElementById('passwordChangeModal').style.display = 'block'; });
                }
            },
            'magaza-adi-sehifesi': { render: function(c){c.innerHTML = `
                        <section class="page"><div class="main-header"><h1><i class="fas fa-store"></i> Mağaza Adının Tənzimlənməsi</h1></div>
                        <form id="magazaAdiFormu"><h3 class="form-section-title">Mağaza Məlumatları</h3><div class="form-group"><label for="magazaAdiInput"><i class="fas fa-signature"></i> Mağaza Adı</label><input type="text" id="magazaAdiInput" placeholder="Məsələn: Texno Ev" required></div><button type="submit" class="submit-btn"><i class="fas fa-save"></i> Yadda Saxla</button></form></section>`;},
                init: function(){
                    document.getElementById('magazaAdiInput').value = magazaAdi;
                    document.getElementById('magazaAdiFormu').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const newName = document.getElementById('magazaAdiInput').value.trim();
                        if (newName) {
                            magazaAdi = newName;
                            await api_updateSetting('magazaAdi', magazaAdi);
                            alert('Mağaza adı uğurla yadda saxlanıldı!');
                        } else {
                            alert('Mağaza adı boş ola bilməz.');
                        }
                    });
                }
            }
        };

        function updateContent(contentId) {
            const contentData = contentMap[contentId] || { render: function(c) { c.innerHTML = `<h1>Xoş Gəlmisiniz!</h1><p>Başlamaq üçün soldakı menyudan bir bölmə seçin.</p>`; }, init: function() {} };
            contentData.render(contentArea);
            contentData.init();
        }

        // <<< ---- GOOGLE SHEETS ENTEQRASIYASI ---- >>>
        
        const GAS_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE'; // <<< BU HİSSƏYƏ ÖZ URL-NİZİ YAPIŞDIRIN

        // === QLOBAL DƏYİŞƏNLƏR ===
        let musteriler = []; 
        let magazaAdi = 'Mağaza Adı'; 
        let passwords = { delete: "1234", edit: "1234" }; 
        
        let muveqqetiData = null;
        let sortState = { column: 'ad', direction: 'asc' };
        let currentConfirmCallback = null;
        const interestRates = { 3: 0.08, 6: 0.08, 9: 0.08, 12: 0.15, 18: 0.20 };

        async function api_call(action, data = {}) {
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    redirect: "follow",
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, ...data })
                });

                if (!response.ok) {
                    throw new Error(`Server xətası: ${response.statusText}`);
                }

                const result = await response.json();
                if (result.status !== 'success') {
                    throw new Error(result.message || 'Naməlum xəta baş verdi');
                }
                return result.data;

            } catch (error) {
                console.error(`API sorğusu zamanı xəta (${action}):`, error);
                alert(`Əməliyyat zamanı xəta baş verdi: ${error.message}\nİnternet bağlantınızı yoxlayın.`);
                return null;
            }
        }

        async function api_updateSetting(key, value) {
            return await api_call('updateSetting', { key, value });
        }
        async function api_updatePassword(passType, currentPass, newPass) {
             return await api_call('updatePassword', { passType, currentPass, newPass });
        }

        function getFullName(musteri) { if (!musteri) return ''; return `${musteri.ad || ''} ${musteri.soyad || ''} ${musteri.ataAdi || ''}`.trim(); }
        
        function generateCustomerCode() { 
            return 'M' + String(Date.now()).slice(-5); 
        }
        
        // === QLOBAL HADİSƏ DİNLƏYİCİLƏRİ ===

        document.getElementById('sifreler-form').addEventListener('submit', (e) => handleChangePassword(e));
        document.getElementById('sifreler-form-edit').addEventListener('submit', (e) => handleChangePassword(e));
        
        document.getElementById('confirmMuqavileBtn').addEventListener('click', async function() {
            if (muveqqetiData && muveqqetiData.faktura) {
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gözləyin...';
                
                const { customer, faktura } = muveqqetiData;
                const isNewCustomer = !customer.id || !musteriler.some(m => m.id === customer.id);

                const result = await api_call('addCreditSale', { customer, faktura, isNewCustomer });

                if(result) {
                    if (isNewCustomer) {
                        musteriler.push(result.customer);
                    } else {
                        const musteriIndex = musteriler.findIndex(m => m.id === result.customer.id);
                        if (musteriIndex > -1) {
                           if (!musteriler[musteriIndex].fakturalar) musteriler[musteriIndex].fakturalar = [];
                           musteriler[musteriIndex].fakturalar.push(result.faktura);
                        }
                    }
                    
                    alert('Müqavilə uğurla yadda saxlanıldı!');
                    this.innerHTML = '<i class="fas fa-check"></i> Təsdiqləndi';
                    
                    const currentForm = document.getElementById('kreditFormu');
                    if (currentForm) {
                        currentForm.reset();
                        resetKreditFormCustomer();
                        calculateKreditDetails();
                    }
                    muveqqetiData = null;
                } else {
                    alert("Xəta: Müqavilə yadda saxlanılmadı.");
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-check"></i> Təsdiqlə və Yadda Saxla';
                }
            } else {
                alert("Xəta: Müqavilə məlumatları tapılmadı.");
            }
        });

        document.getElementById('editMusteriFormu').addEventListener('submit', (e) => {
            e.preventDefault();
            showConfirm('Dəyişiklikləri Yadda Saxla', 'Müştərinin şəxsi məlumatlarında edilən dəyişiklikləri yadda saxlamağa əminsiniz?', async () => {
                const id = parseInt(document.getElementById('editMusteriId').value);
                const musteriIndex = musteriler.findIndex(m => m.id === id);
                if (musteriIndex > -1) {
                    const updatedCustomerData = {
                        id: id,
                        ad: document.getElementById('editAd').value,
                        soyad: document.getElementById('editSoyad').value,
                        ataAdi: document.getElementById('editAtaAdi').value,
                        cins: document.getElementById('editCins').value,
                        finKod: document.getElementById('editFinKod').value.toUpperCase(),
                        vesiqeSeria: document.getElementById('editVesiqeSeria').value + ' ' + document.getElementById('editVesiqeNomre').value,
                        nomreler: [ document.getElementById('editMobil1').value, document.getElementById('editMobil2').value, document.getElementById('editMobil3').value ].filter(n => n)
                    };

                    const result = await api_call('updateCustomer', { customerData: updatedCustomerData });

                    if (result && result.updatedCustomer) {
                        // Nömrələrin string-dən array-ə çevrilməsini təmin edirik
                        if (typeof result.updatedCustomer.nomreler === 'string') {
                            result.updatedCustomer.nomreler = result.updatedCustomer.nomreler.split(',').filter(n => n);
                        }
                        Object.assign(musteriler[musteriIndex], result.updatedCustomer);
                        
                        document.getElementById('editModal').style.display = 'none';
                        alert('Müştəri məlumatları uğurla yeniləndi!');
                        renderMusteriler();
                    }
                }
            });
        });

        document.getElementById('odenisFormu').addEventListener('submit', (e) => {
            e.preventDefault();
            const odenilenMebleg = parseFloat(document.getElementById('odenilenMebleg').value);
            if (odenilenMebleg <= 0) { alert("Ödəniş məbləği 0-dan böyük olmalıdır."); return; }
            showConfirm('Ödənişi Təsdiqlə', `${odenilenMebleg.toFixed(2)} AZN məbləğində ödənişi təsdiqləyirsiniz?`, processPayment);
        });

        document.getElementById('confirmBtnYes').addEventListener('click', () => { if (currentConfirmCallback) { currentConfirmCallback(); } document.getElementById('confirmModal').style.display = 'none'; });
        document.getElementById('confirmBtnNo').addEventListener('click', () => { document.getElementById('confirmModal').style.display = 'none'; });

        const odenisUsuluSelect = document.getElementById('odenisUsulu');
        odenisUsuluSelect.addEventListener('change', () => { if (odenisUsuluSelect.value === 'Kart/Nağd') { document.getElementById('mixedPaymentDiv').style.display = 'block'; document.getElementById('odenilenMebleg').readOnly = true; } else { document.getElementById('mixedPaymentDiv').style.display = 'none'; document.getElementById('odenilenMebleg').readOnly = false; } });
        ['odenisKartMebleg', 'odenisNagdMebleg'].forEach(id => { document.getElementById(id).addEventListener('input', () => { if (document.getElementById('odenisUsulu').value === 'Kart/Nağd') { const kart = parseFloat(document.getElementById('odenisKartMebleg').value) || 0; const nagd = parseFloat(document.getElementById('odenisNagdMebleg').value) || 0; document.getElementById('odenilenMebleg').value = (kart + nagd).toFixed(2); } }); });

        [ 'closePasswordChangeModal', 'closeOdenisModal', 'closeCekModal', 'closeNagdCekModal', 'closeEditModal', 'closeMuqavileModal', 'closeTarixceModal', 'closeDetailsModal' ].forEach(id => { const b = document.getElementById(id); if (b) { const modalId = id.replace('close', '').charAt(0).toLowerCase() + id.slice(6); b.onclick = () => { const m = document.getElementById(modalId); if(m) m.style.display = 'none'; }; } });
        
        ['printCekBtn', 'printNagdCekBtn', 'printMuqavileBtn', 'tarixce-print-btn'].forEach(id => { document.getElementById(id).addEventListener('click', () => window.print()); });
        window.onclick = (event) => { if (event.target.classList.contains('modal')) { event.target.style.display = 'none'; } };

        document.getElementById('fakturaTarixcesiBody').addEventListener('click', handleFakturaTarixcesiActions);
        document.getElementById('tarixceCedveliBody').addEventListener('click', handleTarixceActions);

        // === FUNKSİYALAR ===
        
        function setDefaultDatesAndFilter(startId, endId, filterFunction) { const today = new Date().toISOString().split('T')[0]; document.getElementById(startId).value = today; document.getElementById(endId).value = today; filterFunction(new Event('submit')); }
        function handleSatisHesabatiFilter(e) { if(e) e.preventDefault(); const startDate = document.getElementById('satisHesabatiBaslamaTarixi').value; const endDate = document.getElementById('satisHesabatiBitmeTarixi').value; const tbody = document.getElementById('satisHesabatiCedveli'); if (!startDate || !endDate) { alert("Zəhmət olmasa, başlama və bitmə tarixlərini seçin."); return; } const start = new Date(startDate); start.setHours(0,0,0,0); const end = new Date(endDate); end.setHours(23,59,59,999); tbody.innerHTML = ''; let found = false; musteriler.forEach(musteri => { (musteri.fakturalar || []).forEach(faktura => { if (faktura.tip === 'nagd') { const fakturaDate = new Date(faktura.tarix); if (fakturaDate >= start && fakturaDate <= end) { found = true; const tr = `<tr><td>${faktura.fakturaId}</td><td>${fakturaDate.toLocaleString('az-AZ')}</td><td>${getFullName(musteri)} (${musteri.musteriKodu})</td><td>${faktura.mebleg.toFixed(2)}</td><td>${faktura.usulText || faktura.usul}</td></tr>`; tbody.innerHTML += tr; } } }); }); if (!found) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Seçilmiş tarix aralığında nağd satış tapılmadı.</td></tr>`; } }
        function handleKassaHesabatiFilter(e) { if(e) e.preventDefault(); const startDate = document.getElementById('kassaHesabatiBaslamaTarixi').value; const endDate = document.getElementById('kassaHesabatiBitmeTarixi').value; const odenisUsulu = document.getElementById('kassaHesabatiOdenisUsulu').value; const tbody = document.getElementById('kassaHesabatiCedveli'); if (!startDate || !endDate) { alert("Zəhmət olmasa, başlama və bitmə tarixlərini seçin."); return; } const start = new Date(startDate); start.setHours(0,0,0,0); const end = new Date(endDate); end.setHours(23,59,59,999); tbody.innerHTML = ''; let found = false; musteriler.forEach(musteri => { (musteri.fakturalar || []).forEach(faktura => { if (faktura.tip === 'kredit' && faktura.odenisQrafiki) { faktura.odenisQrafiki.forEach(ay => { (ay.odenisler || []).forEach(odenis => { const odenisDate = new Date(odenis.tarix); const usulMatch = (odenisUsulu === 'Hamisi') || (odenis.usul === odenisUsulu); if (odenisDate >= start && odenisDate <= end && usulMatch) { found = true; const tr = `<tr><td>${odenis.id}</td><td>${odenisDate.toLocaleString('az-AZ')}</td><td>${getFullName(musteri)} (${musteri.musteriKodu})</td><td>${faktura.mehsulAdi}</td><td>${odenis.mebleg.toFixed(2)}</td><td>${odenis.usulText || odenis.usul}</td></tr>`; tbody.innerHTML += tr; } }); }); } }); }); if (!found) { tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Seçilmiş filterlərə uyğun kredit ödənişi tapılmadı.</td></tr>`; } }
        function handleBankOdenisleriFilter(e) { if(e) e.preventDefault(); const selectedDateStr = document.getElementById('bankOdenisleriTarix').value; const totalEl = document.getElementById('bankOdenisleriCemi'); if (!selectedDateStr) { alert("Zəhmət olmasa, bir tarix seçin."); return; } const selectedDate = new Date(selectedDateStr); let totalKartOdenis = 0; musteriler.forEach(musteri => { (musteri.fakturalar || []).forEach(faktura => { const fakturaDate = new Date(faktura.tarix); if (faktura.tip === 'nagd' && isSameDay(fakturaDate, selectedDate)) { if (faktura.usul === 'Kart ilə') { totalKartOdenis += faktura.mebleg; } else if (faktura.usul === 'Kart/Nağd') { totalKartOdenis += faktura.meblegKart || 0; } } else if (faktura.tip === 'kredit' && faktura.odenisQrafiki) { faktura.odenisQrafiki.forEach(ay => { (ay.odenisler || []).forEach(odenis => { const odenisDate = new Date(odenis.tarix); if (isSameDay(odenisDate, selectedDate)) { if (odenis.usul === 'Kart') { totalKartOdenis += odenis.mebleg; } else if (odenis.usul === 'Kart/Nağd') { totalKartOdenis += odenis.meblegKart || 0; } } }); }); } }); }); totalEl.textContent = `${totalKartOdenis.toFixed(2)} AZN`; }
        
        async function handleChangePassword(e) { 
            e.preventDefault(); 
            const form = e.target.closest('form'); 
            const passType = form.querySelector('button[type="submit"]').dataset.passType; 
            const currentPassInput = document.getElementById(`${passType}-current-pass`); 
            const newPassInput = document.getElementById(`${passType}-new-pass`); 
            const feedbackEl = document.getElementById(`${passType}-feedback`); 
            const currentPass = currentPassInput.value; 
            const newPass = newPassInput.value; 
            
            if(newPass.length < 4){ 
                feedbackEl.textContent = "Yeni şifrə ən az 4 simvol olmalıdır."; 
                feedbackEl.style.color = 'var(--danger-color)'; 
                return; 
            }

            const result = await api_updatePassword(passType, currentPass, newPass);
            
            if (result && result.success) {
                passwords[passType] = newPass;
                feedbackEl.textContent = "Şifrə uğurla dəyişdirildi!"; 
                feedbackEl.style.color = 'var(--success-color)'; 
                form.reset(); 
                setTimeout(() => { document.getElementById('passwordChangeModal').style.display = 'none'; feedbackEl.textContent = ''; }, 1500);
            } else {
                feedbackEl.textContent = (result && result.message) ? result.message : "Cari şifrə yanlışdır!"; 
                feedbackEl.style.color = 'var(--danger-color)';
            }
            setTimeout(() => feedbackEl.textContent = '', 3000); 
        }

        function handleKassaSearch(e) { e.preventDefault(); const searchBtn = e.target.closest('form').querySelector('button[type="submit"]'); const searchIcon = searchBtn.querySelector('i'); const originalIconClass = searchBtn.innerHTML ; searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Axtarılır...'; searchBtn.disabled = true; try { const ad = document.getElementById('kassaAxtarAd').value.toLowerCase().trim(); const fin = document.getElementById('kassaAxtarFin').value.toLowerCase().trim(); const tel = document.getElementById('kassaAxtarTel').value.trim(); const kassaAxtarCedveli = document.getElementById('kassaAxtarCedveli'); const kassaAxtarNeticeleri = document.getElementById('kassaAxtarNeticeleri'); if (!ad && !fin && !tel) { alert("Axtarış üçün ən az bir xananı doldurun."); return; } const tapilanlar = musteriler.filter(m => { const adMatch = ad && (getFullName(m).toLowerCase().includes(ad) || (m.musteriKodu && m.musteriKodu.toLowerCase().includes(ad))); const finMatch = fin && m.finKod && m.finKod.toLowerCase().includes(fin); const telMatch = tel && Array.isArray(m.nomreler) && m.nomreler.some(n => n.includes(tel)); return adMatch || finMatch || telMatch; }); kassaAxtarCedveli.innerHTML = ''; let resultsFound = false; if (tapilanlar.length > 0) { tapilanlar.forEach(musteri => { const aktivKreditler = (musteri.fakturalar || []).filter(f => f.tip === 'kredit' && getFakturaQaliqBorc(f) > 0.01); if (aktivKreditler.length === 0) { resultsFound = true; const tr = `<tr><td>${getFullName(musteri)} <span class="customer-code">${musteri.musteriKodu}</span></td><td colspan="3" style="text-align:center;">Bu müştərinin aktiv kredit borcu yoxdur.</td><td><button class="action-btn view-details-btn" data-id="${musteri.id}"><i class="fas fa-eye"></i> Bax</button></td></tr>`; kassaAxtarCedveli.innerHTML += tr; } else { aktivKreditler.forEach(faktura => { resultsFound = true; const qaliqBorc = getFakturaQaliqBorc(faktura); const novbetiOdenisAyi = faktura.odenisQrafiki.find(ay => (ay.odenmeli - ay.odenmis) > 0.01); const novbetiTarix = novbetiOdenisAyi ? new Date(novbetiOdenisAyi.tarix).toLocaleDateString('az-AZ') : 'Bitib'; const tr = `<tr data-id="${musteri.id}" data-faktura-id="${faktura.fakturaId}"><td>${getFullName(musteri)} <span class="customer-code">${musteri.musteriKodu}</span></td><td>${faktura.mehsulAdi}</td><td>${qaliqBorc.toFixed(2)} AZN</td><td>${novbetiTarix}</td><td><button class="action-btn pay-btn"><i class="fas fa-dollar-sign"></i> Ödə</button><button class="action-btn details-btn"><i class="fas fa-calendar-alt"></i></button></td></tr>`; kassaAxtarCedveli.innerHTML += tr; }); } }); } if (!resultsFound) { kassaAxtarCedveli.innerHTML = `<tr><td colspan="5" style="text-align:center;">Axtarışa uyğun aktiv kreditli müştəri tapılmadı.</td></tr>`; } kassaAxtarNeticeleri.style.display = 'block'; } finally { searchBtn.innerHTML = originalIconClass; searchBtn.disabled = false; } }
        function resetNagdFormCustomer() { document.getElementById('nagdMusteriId').value = ''; document.getElementById('selectedCustomerInfo').style.display = 'none'; document.getElementById('customerSearchArea').style.display = 'block'; document.getElementById('nagdMusteriAxtarInput').value = ''; document.getElementById('nagdMusteriAxtarNeticeleri').style.display = 'none'; document.getElementById('nagdAd').value = ''; document.getElementById('nagdSoyad').value = ''; document.getElementById('nagdAtaAdi').value = ''; document.getElementById('nagdFinKod').value = ''; document.getElementById('nagdMobilNomre').value = ''; }
        function handleNagdMusteriSearch() { const searchTerm = document.getElementById('nagdMusteriAxtarInput').value.toLowerCase().trim(); if (searchTerm.length < 2) { document.getElementById('nagdMusteriAxtarNeticeleri').style.display = 'none'; return; } const tapilanlar = musteriler.filter(m => (getFullName(m).toLowerCase().includes(searchTerm)) || (m.musteriKodu && m.musteriKodu.toLowerCase().includes(searchTerm)) || (m.finKod && m.finKod.toLowerCase().includes(searchTerm)) || (Array.isArray(m.nomreler) && m.nomreler.some(n => n.includes(searchTerm))) ); const cedvel = document.getElementById('nagdMusteriAxtarCedveli'); cedvel.innerHTML = ''; if (tapilanlar.length > 0) { tapilanlar.forEach(musteri => { const tr = `<tr><td>${getFullName(musteri)} <span class="customer-code">${musteri.musteriKodu}</span></td><td>${musteri.finKod || '---'}</td><td>${(musteri.nomreler || []).join(', ')}</td><td><button type="button" class="action-btn select-customer-btn" data-id="${musteri.id}">Seç</button></td></tr>`; cedvel.innerHTML += tr; }); document.getElementById('nagdMusteriAxtarNeticeleri').style.display = 'block'; } else { cedvel.innerHTML = `<tr><td colspan="4" style="text-align:center;">Müştəri tapılmadı.</td></tr>`; document.getElementById('nagdMusteriAxtarNeticeleri').style.display = 'block'; } }
        function handleSelectNagdMusteri(e) { if (e.target.classList.contains('select-customer-btn')) { const id = parseInt(e.target.dataset.id); const musteri = musteriler.find(m => m.id === id); if (musteri) { document.getElementById('nagdMusteriId').value = musteri.id; document.getElementById('selectedCustomerInfo').innerHTML = `<p><strong>Seçilmiş Müştəri:</strong> ${getFullName(musteri)} (${musteri.musteriKodu}) <button type="button" class="action-btn" onclick="resetNagdFormCustomer();">Ləğv et</button></p>`; document.getElementById('selectedCustomerInfo').style.display = 'block'; document.getElementById('customerSearchArea').style.display = 'none'; document.getElementById('nagdMusteriAxtarNeticeleri').style.display = 'none'; } } }
        
        async function handleNagdSubmit(e) { 
            e.preventDefault(); 
            const satisMelumatlari = { mehsulAdi: document.getElementById('nagdMehsulAdi').value, qiymet: parseFloat(document.getElementById('nagdMehsulQiymeti').value), usul: document.getElementById('nagdOdenisUsulu').value, yeniMusteridir: document.getElementById('yeniMusteriCheckbox').checked, secilmisMusteriId: parseInt(document.getElementById('nagdMusteriId').value) || null, yeniMusteriMelumatlari: { ad: document.getElementById('nagdAd').value, soyad: document.getElementById('nagdSoyad').value, ataAdi: document.getElementById('nagdAtaAdi').value, cins: document.getElementById('nagdCins').value, finKod: document.getElementById('nagdFinKod').value.toUpperCase(), nomre: document.getElementById('nagdMobilNomre').value ? document.getElementById('nagdMobilPrefix').value + document.getElementById('nagdMobilNomre').value : '' } }; 
            if (!satisMelumatlari.mehsulAdi || isNaN(satisMelumatlari.qiymet) || satisMelumatlari.qiymet <= 0) { alert('Məhsul adı və qiyməti düzgün daxil edilməlidir.'); return; } 
            if (satisMelumatlari.yeniMusteridir && (!satisMelumatlari.yeniMusteriMelumatlari.ad || !satisMelumatlari.yeniMusteriMelumatlari.soyad)) { alert('Yeni müştərinin adını və soyadını daxil edin.'); return; } 
            if (!satisMelumatlari.yeniMusteridir && !satisMelumatlari.secilmisMusteriId) { alert('Zəhmət olmasa, mövcud müştərini seçin və ya yeni müştəri kimi qeyd edin.'); return; } 
            showConfirm('Satışı Təsdiqlə', 'Bu nağd satışı təsdiqləyirsiniz?', () => processNagdSale(satisMelumatlari)); 
        }

        async function processNagdSale(satis) { 
            let musteriData; 
            let isNewCustomer = false; 
            if (!satis.yeniMusteridir && satis.secilmisMusteriId) { 
                musteriData = musteriler.find(m => m.id === satis.secilmisMusteriId); 
            } else { 
                isNewCustomer = true; 
                const fin = satis.yeniMusteriMelumatlari.finKod; 
                let existingMusteriByFin = fin ? musteriler.find(m => m.finKod === fin) : null; 
                if (existingMusteriByFin) { 
                    isNewCustomer = false; musteriData = existingMusteriByFin; 
                } else { 
                    musteriData = { ad: satis.yeniMusteriMelumatlari.ad, soyad: satis.yeniMusteriMelumatlari.soyad, ataAdi: satis.yeniMusteriMelumatlari.ataAdi, cins: satis.yeniMusteriMelumatlari.cins, finKod: satis.yeniMusteriMelumatlari.finKod || '', vesiqeSeria: '', nomreler: satis.yeniMusteriMelumatlari.nomre ? [satis.yeniMusteriMelumatlari.nomre] : [] }; 
                } 
            } 
            
            if (!musteriData) { alert("Xəta: Müştəri məlumatı tapılmadı."); return; } 
            
            const yeniFaktura = { tip: "nagd", tarix: new Date().toISOString(), mehsulAdi: satis.mehsulAdi, mebleg: satis.qiymet, usul: satis.usul }; 
            if (satis.usul === 'Kart/Nağd') { 
                const kartMebleg = parseFloat(document.getElementById('nagdKartMebleg').value) || 0; 
                const nagdMebleg = parseFloat(document.getElementById('nagdNagdMebleg').value) || 0; 
                if(Math.abs((kartMebleg + nagdMebleg) - satis.qiymet) > 0.01){ alert('Kart və nağd məbləğlərin cəmi satış qiymətinə bərabər deyil!'); return; } 
                yeniFaktura.meblegKart = kartMebleg; yeniFaktura.meblegNagd = nagdMebleg; yeniFaktura.usulText = `Kart (${kartMebleg.toFixed(2)}) + Nağd (${nagdMebleg.toFixed(2)})`; 
            } 
            
            const result = await api_call('addNagdSale', { customerData, fakturaData: yeniFaktura, isNewCustomer });

            if(result && result.customer && result.faktura) {
                if (isNewCustomer) {
                    if (typeof result.customer.nomreler === 'string') result.customer.nomreler = result.customer.nomreler.split(',');
                    musteriler.push(result.customer);
                    alert("Yeni müştəri və satış uğurla əlavə edildi!");
                } else {
                    const musteriIndex = musteriler.findIndex(m => m.id === result.customer.id);
                    if (musteriIndex > -1) {
                        if (!musteriler[musteriIndex].fakturalar) musteriler[musteriIndex].fakturalar = [];
                        musteriler[musteriIndex].fakturalar.push(result.faktura);
                    }
                    alert("Satış uğurla əlavə edildi!");
                }

                openNagdCekModal(result.customer, result.faktura); 
                document.getElementById('nagdFormu').reset();
                const checkbox = document.getElementById('yeniMusteriCheckbox');
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change'));
            }
        }
        
        function openNagdCekModal(musteri, faktura) { document.getElementById('nagdCekSatici').textContent = magazaAdi; document.getElementById('nagdCekId').textContent = faktura.fakturaId; document.getElementById('nagdCekTarix').textContent = new Date(faktura.tarix).toLocaleString('az-AZ'); document.getElementById('nagdCekMusteriAdi').textContent = `${getFullName(musteri)} (${musteri.musteriKodu})`; document.getElementById('nagdCekMehsulAdi').textContent = faktura.mehsulAdi || faktura.mehsul; document.getElementById('nagdCekOdenenMebleg').textContent = faktura.mebleg.toFixed(2); document.getElementById('nagdCekOdenisUsulu').textContent = faktura.usulText || faktura.usul; document.getElementById('nagdCekModal').style.display = 'block'; }
        function resetKreditFormCustomer(resetCheckbox = true) { document.getElementById('kreditMusteriId').value = ''; document.getElementById('selectedKreditCustomerInfo').style.display = 'none'; document.getElementById('kreditCustomerSearchArea').style.display = 'block'; document.getElementById('kreditMusteriAxtarInput').value = ''; document.getElementById('kreditMusteriAxtarNeticeleri').style.display = 'none'; const fieldsToReset = ['ad', 'soyad', 'ataAdi', 'finKod', 'vesiqeNomre', 'mobil1-nomre', 'mobil2-nomre', 'mobil3-nomre']; fieldsToReset.forEach(id => { const el = document.getElementById(id); el.value = ''; el.readOnly = false; }); document.getElementById('cins').disabled = false; document.getElementById('vesiqeSeria').disabled = false; document.getElementById('mobil1-prefix').disabled = false; document.getElementById('mobil2-prefix').disabled = false; document.getElementById('mobil3-prefix').disabled = false; if(resetCheckbox) { document.getElementById('yeniKreditMusteriCheckbox').checked = true; document.getElementById('yeniKreditMusteriFormu').style.display = 'block'; document.getElementById('movcudKreditMusteriFormu').style.display = 'none'; toggleKreditFormRequired(false); } }
        function handleKreditMusteriSearch() {
            const searchTerm = document.getElementById('kreditMusteriAxtarInput').value.toLowerCase().trim();
            const neticelerContainer = document.getElementById('kreditMusteriAxtarNeticeleri');
            const cedvelBody = document.getElementById('kreditMusteriAxtarCedveli');
            
            cedvelBody.innerHTML = ''; 

            if (searchTerm.length < 2) {
                neticelerContainer.style.display = 'none';
                return;
            }

            const tapilanlar = musteriler.filter(m =>
                (getFullName(m).toLowerCase().includes(searchTerm)) ||
                (m.musteriKodu && m.musteriKodu.toLowerCase().includes(searchTerm)) ||
                (m.finKod && m.finKod.toLowerCase().includes(searchTerm)) ||
                (Array.isArray(m.nomreler) && m.nomreler.some(n => n.includes(searchTerm)))
            );

            if (tapilanlar.length > 0) {
                tapilanlar.forEach(musteri => {
                    const tr = `<tr>
                        <td>${getFullName(musteri)} <span class="customer-code">${musteri.musteriKodu}</span></td>
                        <td>${musteri.finKod || '---'}</td>
                        <td>${(musteri.nomreler || []).join(', ')}</td>
                        <td><button type="button" class="action-btn select-customer-btn" data-id="${musteri.id}">Seç</button></td>
                    </tr>`;
                    cedvelBody.innerHTML += tr;
                });
            } else {
                cedvelBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Müştəri tapılmadı.</td></tr>`;
            }
            neticelerContainer.style.display = 'block';
        }
        function handleSelectKreditMusteri(e) { if (e.target.classList.contains('select-customer-btn')) { const id = parseInt(e.target.dataset.id); const musteri = musteriler.find(m => m.id === id); if (musteri) { document.getElementById('kreditMusteriId').value = musteri.id; document.getElementById('selectedKreditCustomerInfo').innerHTML = `<p><strong>Seçilmiş Müştəri:</strong> ${getFullName(musteri)} (${musteri.musteriKodu}) <button type="button" class="action-btn" onclick="resetKreditFormCustomer(false)">Ləğv et</button></p>`; document.getElementById('selectedKreditCustomerInfo').style.display = 'block'; document.getElementById('kreditCustomerSearchArea').style.display = 'none'; document.getElementById('kreditMusteriAxtarNeticeleri').style.display = 'none'; fillAndLockKreditForm(musteri); toggleKreditFormRequired(true); } } }
        function fillAndLockKreditForm(musteri) { document.getElementById('ad').value = musteri.ad; document.getElementById('soyad').value = musteri.soyad; document.getElementById('ataAdi').value = musteri.ataAdi; document.getElementById('cins').value = musteri.cins || 'Kişi'; document.getElementById('finKod').value = musteri.finKod; const [seria, ...nomreParts] = (musteri.vesiqeSeria || '').split(' '); const nomre = nomreParts.join(''); document.getElementById('vesiqeSeria').value = seria || 'AZE'; document.getElementById('vesiqeNomre').value = nomre || ''; const nomreler = musteri.nomreler || []; if(nomreler[0]) { try{ document.getElementById('mobil1-prefix').value = nomreler[0].substring(0, 3); document.getElementById('mobil1-nomre').value = nomreler[0].substring(3); } catch(e){} } if(nomreler[1]) { try{ document.getElementById('mobil2-prefix').value = nomreler[1].substring(0, 3); document.getElementById('mobil2-nomre').value = nomreler[1].substring(3); } catch(e){} } if(nomreler[2]) { try{ document.getElementById('mobil3-prefix').value = nomreler[2].substring(0, 3); document.getElementById('mobil3-nomre').value = nomreler[2].substring(3); } catch(e){} } const fieldsToLock = ['ad', 'soyad', 'ataAdi', 'finKod', 'vesiqeNomre', 'mobil1-nomre', 'mobil2-nomre', 'mobil3-nomre']; fieldsToLock.forEach(id => document.getElementById(id).readOnly = true); ['cins', 'vesiqeSeria', 'mobil1-prefix', 'mobil2-prefix', 'mobil3-prefix'].forEach(id => document.getElementById(id).disabled = true); document.getElementById('yeniKreditMusteriFormu').style.display = 'block'; }
        function toggleKreditFormRequired(isExisting) { const fields = ['ad', 'soyad', 'ataAdi', 'finKod', 'vesiqeNomre', 'mobil1-nomre']; fields.forEach(id => { document.getElementById(id).required = !isExisting; }); }
        function handleKreditFormSubmit(e) { e.preventDefault(); const isYeniMusteri = document.getElementById('yeniKreditMusteriCheckbox').checked; const secilmisMusteriId = parseInt(document.getElementById('kreditMusteriId').value) || null; let customerData; if (!isYeniMusteri && secilmisMusteriId) { customerData = musteriler.find(m => m.id === secilmisMusteriId); if (!customerData) { alert("Seçilmiş müştəri tapılmadı. Zəhmət olmasa, yenidən seçin."); return; } } else { customerData = { ad: document.getElementById('ad').value, soyad: document.getElementById('soyad').value, ataAdi: document.getElementById('ataAdi').value, cins: document.getElementById('cins').value, finKod: document.getElementById('finKod').value.toUpperCase(), vesiqeSeria: document.getElementById('vesiqeSeria').value + ' ' + document.getElementById('vesiqeNomre').value, nomreler: [] }; if (document.getElementById('mobil1-nomre').value) customerData.nomreler.push(document.getElementById('mobil1-prefix').value + document.getElementById('mobil1-nomre').value); if (document.getElementById('mobil2-nomre').value) customerData.nomreler.push(document.getElementById('mobil2-prefix').value + document.getElementById('mobil2-nomre').value); if (document.getElementById('mobil3-nomre').value) customerData.nomreler.push(document.getElementById('mobil3-prefix').value + document.getElementById('mobil3-nomre').value); } const ayliqOdenis = parseFloat(document.getElementById('ayliqOdenis').value); const kreditMuddeti = parseInt(document.getElementById('kreditMuddeti').value); const odenisQrafiki = []; let ilkOdenisTarixi = new Date(); for(let i=0; i < kreditMuddeti; i++){ ilkOdenisTarixi.setMonth(ilkOdenisTarixi.getMonth() + 1); odenisQrafiki.push({ ay: i + 1, tarix: new Date(ilkOdenisTarixi).toISOString().split('T')[0], odenmeli: ayliqOdenis, odenmis: 0, odenisler: [] }); } const yeniFaktura = { tip: "kredit", tarix: new Date().toISOString(), mehsulAdi: document.getElementById('mehsulAdi').value, mehsulKateqoriya: document.getElementById('mehsulKateqoriya').value, nagdQiymet: parseFloat(document.getElementById('nagdQiymet').value), kreditQiymeti: parseFloat(document.getElementById('kreditQiymeti').value), ilkinOdenis: parseFloat(document.getElementById('ilkinOdenis').value) || 0, kreditMuddeti: kreditMuddeti, odenisQrafiki: odenisQrafiki }; muveqqetiData = { customer: customerData, faktura: yeniFaktura }; openMuqavileModal(muveqqetiData); }
        function renderCurrentDayReport() { let totalNagd = 0; let totalKart = 0; const selectedDate = new Date(); musteriler.forEach(musteri => { if (!musteri.fakturalar) return; musteri.fakturalar.forEach(faktura => { const fakturaDate = new Date(faktura.tarix); if (faktura.tip === 'nagd' && isSameDay(fakturaDate, selectedDate)) { let nagdAmount = 0; let kartAmount = 0; if (faktura.usul === 'Nağd') { nagdAmount = faktura.mebleg; } else if (faktura.usul === 'Kart ilə') { kartAmount = faktura.mebleg; } else if (faktura.usul === 'Kart/Nağd') { nagdAmount = faktura.meblegNagd || 0; kartAmount = faktura.meblegKart || 0; } totalNagd += nagdAmount; totalKart += kartAmount; } else if (faktura.tip === 'kredit' && faktura.odenisQrafiki) { faktura.odenisQrafiki.forEach(ay => { if (!ay.odenisler) return; ay.odenisler.forEach(odenis => { const odenisDate = new Date(odenis.tarix); if (isSameDay(odenisDate, selectedDate)) { let nagdAmount = 0; let kartAmount = 0; if (odenis.usul === 'Nağd') { nagdAmount = odenis.mebleg; } else if (odenis.usul === 'Kart') { kartAmount = odenis.mebleg; } else if (odenis.usul === 'Kart/Nağd') { nagdAmount = odenis.meblegNagd || 0; kartAmount = odenis.meblegKart || 0; } totalNagd += nagdAmount; totalKart += kartAmount; } }); }); } }); }); document.getElementById('gunSonuNagdCemi').textContent = `${totalNagd.toFixed(2)} AZN`; document.getElementById('gunSonuKartCemi').textContent = `${totalKart.toFixed(2)} AZN`; document.getElementById('gunSonuUmumiCemi').textContent = `${(totalNagd + totalKart).toFixed(2)} AZN`; }
        function isSameDay(date1, date2) { return date1.getFullYear() === date2.getFullYear() && date1.getMonth() === date2.getMonth() && date1.getDate() === date2.getDate(); }
        function showConfirm(title, text, callback) { document.getElementById('confirmTitle').textContent = title; document.getElementById('confirmText').textContent = text; currentConfirmCallback = callback; document.getElementById('confirmModal').style.display = 'block'; }
        
        async function processPayment() { 
            const id = parseInt(document.getElementById('modalMusteriId').value); 
            const fakturaId = document.getElementById('modalFakturaId').value; 
            const musteriIndex = musteriler.findIndex(m => m.id === id); if(musteriIndex === -1) return; 
            const musteri = musteriler[musteriIndex]; 
            const fakturaIndex = musteri.fakturalar.findIndex(f => f.fakturaId === fakturaId); if(fakturaIndex === -1) return; 
            const ayIndex = parseInt(document.getElementById('modalOdenisAyIndex').value); 
            const odenilenMebleg = parseFloat(document.getElementById('odenilenMebleg').value); 
            const odenisUsulu = document.getElementById('odenisUsulu').value; 
            
            const yeniOdenis = { mebleg: odenilenMebleg, usul: odenisUsulu }; 
            if(odenisUsulu === 'Kart/Nağd') { 
                const kartMebleg = parseFloat(document.getElementById('odenisKartMebleg').value) || 0; 
                const nagdMebleg = parseFloat(document.getElementById('odenisNagdMebleg').value) || 0; 
                if(Math.abs((kartMebleg + nagdMebleg) - odenilenMebleg) > 0.01){ alert('Kart və nağd məbləğlərin cəmi ümumi məbləğə bərabər deyil!'); return; } 
                yeniOdenis.meblegKart = kartMebleg; yeniOdenis.meblegNagd = nagdMebleg; yeniOdenis.usulText = `Kart (${kartMebleg.toFixed(2)}) + Nağd (${nagdMebleg.toFixed(2)})`; 
            } 
            
            const result = await api_call('addPayment', { musteriId: id, fakturaId, ayIndex, odenisData: yeniOdenis });

            if (result && result.updatedFaktura) {
                musteriler[musteriIndex].fakturalar[fakturaIndex] = result.updatedFaktura;
                
                document.getElementById('odenisModal').style.display = 'none'; 
                // Yeni ödənişin ID-si və tarixi serverdən gələn cavabda olmalıdır, bu hissəni adaptasiya etmək lazım ola bilər
                const addedPayment = result.updatedFaktura.odenisQrafiki.flatMap(ay => ay.odenisler).find(o => !o.id.startsWith("Q")); // Təxmini tapılma
                openCekModal(musteri, result.updatedFaktura, result.addedPayment || yeniOdenis);
                updateDashboard();
                renderMusteriler();
            }
        }
        
        function calculateKreditDetails() { const n = document.getElementById('nagdQiymet'); if(!n) return; const q = parseFloat(n.value) || 0; const m = parseInt(document.getElementById('kreditMuddeti').value); const i = parseFloat(document.getElementById('ilkinOdenis').value) || 0; if (q > 0) { const faiz = interestRates[m] || 0; const kreditQiymeti = q * (1 + faiz); document.getElementById('kreditQiymeti').value = kreditQiymeti.toFixed(2); const qaliqBorc = kreditQiymeti - i; if (qaliqBorc > 0 && m > 0) { const ayliqOdenis = qaliqBorc / m; document.getElementById('ayliqOdenis').value = ayliqOdenis.toFixed(2); } else { document.getElementById('ayliqOdenis').value = '0.00'; } } else { document.getElementById('kreditQiymeti').value = ''; document.getElementById('ayliqOdenis').value = ''; } }
        
        function handleTableActions(e) { 
            const target = e.target; 
            const tr = target.closest('tr'); if (!tr) return; 
            const id = parseInt(tr.dataset.id); 
            const fakturaId = tr.dataset.fakturaId; 
            const musteri = musteriler.find(m => m.id === id); if (!musteri) return; 
            let faktura = null; if(fakturaId) { faktura = (musteri.fakturalar || []).find(f => f.fakturaId === fakturaId); } 
            if (target.closest('.details-btn')) { if (faktura && faktura.tip === 'kredit') { openOdenisTarixcesiModal(id, fakturaId, false); } } 
            if (target.closest('.edit-btn')) openEditModal(id); 
            if (target.closest('.view-details-btn')) openDetailsModal(id); 
            if (target.closest('.delete-btn')) { 
                const password = prompt("Müştərini silmək üçün şifrəni daxil edin:"); 
                if (password === passwords.delete) { 
                    showConfirm('Silmə Əməliyyatı', 'Bu müştərini və bütün məlumatlarını silməyə əminsiniz?', async () => { 
                        const result = await api_call('deleteCustomer', { customerId: id });
                        if(result && result.success) {
                            musteriler = musteriler.filter(m => m.id !== id); 
                            renderMusteriler(); 
                            updateDashboard();
                        }
                    }); 
                } else if (password !== null) { 
                    alert("Şifrə yanlışdır! Silmə əməliyyatı ləğv edildi."); 
                } 
            } 
            if (target.closest('.pay-btn')) { let targetFaktura = faktura; if (!targetFaktura) { targetFaktura = (musteri.fakturalar || []).find(f => f.tip === 'kredit' && getFakturaQaliqBorc(f) > 0.01); } if (targetFaktura && targetFaktura.odenisQrafiki) { const novbetiOdenisAyIndex = targetFaktura.odenisQrafiki.findIndex(ay => (ay.odenmeli - ay.odenmis) > 0.01); if (novbetiOdenisAyIndex !== -1) { openOdenisModal(id, targetFaktura.fakturaId, novbetiOdenisAyIndex); } else { alert('Müştərinin aktiv borcu yoxdur.'); } } else { alert('Müştərinin aktiv kredit borcu yoxdur.'); } } 
        }

        function handleFakturaTarixcesiActions(e) { const target = e.target.closest('button'); if(!target) return; const musteriId = parseInt(target.dataset.musteriId); const fakturaId = target.dataset.fakturaId; if(target.classList.contains('details-btn')) { openOdenisTarixcesiModal(musteriId, fakturaId, false); } if(target.classList.contains('print-receipt-btn')) { const musteri = musteriler.find(m => m.id === musteriId); const faktura = musteri.fakturalar.find(f => f.fakturaId === fakturaId); if(faktura) openNagdCekModal(musteri, faktura); } }
        async function handleTarixceActions(e) { const target = e.target.closest('button'); if (!target) return; const musteriId = parseInt(target.dataset.musteriId); const fakturaId = target.dataset.fakturaId; const odenisId = target.dataset.odenisId; if(target.classList.contains('edit-payment-btn')) { await handleEditPayment(musteriId, fakturaId, odenisId); } if(target.classList.contains('print-receipt-btn')) { const musteri = musteriler.find(m => m.id === musteriId); const faktura = musteri.fakturalar.find(f => f.fakturaId === fakturaId); const odenis = (faktura.odenisQrafiki || []).flatMap(ay => ay.odenisler || []).find(o => o.id === odenisId); if(odenis) openCekModal(musteri, faktura, odenis); } }
        async function handleEditPayment(musteriId, fakturaId, odenisId) { const password = prompt("Düzəliş etmək üçün şifrəni daxil edin:"); if (password !== passwords.edit) { if (password !== null) alert("Şifrə yanlışdır! Düzəliş ləğv edildi."); return; } const musteriIndex = musteriler.findIndex(m => m.id === musteriId); if(musteriIndex === -1) return; const fakturaIndex = musteriler[musteriIndex].fakturalar.findIndex(f => f.fakturaId === fakturaId); if(fakturaIndex === -1) return; let odenis; for (const ay of musteriler[musteriIndex].fakturalar[fakturaIndex].odenisQrafiki) { const payment = (ay.odenisler || []).find(o => o.id === odenisId); if (payment) { odenis = payment; break; } } if (!odenis) return; const yeniMeblegStr = prompt("Ödəniş üçün yeni məbləği daxil edin:", odenis.mebleg); const yeniMebleg = parseFloat(yeniMeblegStr); if (yeniMeblegStr !== null && !isNaN(yeniMebleg) && yeniMebleg >= 0) {
            
            const result = await api_call('updatePayment', { musteriId, fakturaId, odenisId, yeniMebleg });

            if (result && result.updatedFaktura) {
                musteriler[musteriIndex].fakturalar[fakturaIndex] = result.updatedFaktura;
                openOdenisTarixcesiModal(musteriId, fakturaId, false); // Modalı yenilənmiş məlumatlarla yenidən açırıq
            }

        } else if (yeniMeblegStr !== null) { alert("Düzgün məbləğ daxil edilməyib."); } }
        function handleSort(e) { const th = e.currentTarget; const column = th.dataset.sort; if (sortState.column === column) { sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc'; } else { sortState.column = column; sortState.direction = 'asc'; } renderMusteriler(); }
        function openOdenisModal(musteriId, fakturaId, ayIndex) { const musteri = musteriler.find(m => m.id === musteriId); const faktura = musteri.fakturalar.find(f => f.fakturaId === fakturaId); const odenisAyi = faktura.odenisQrafiki[ayIndex]; const qaliq = odenisAyi.odenmeli - odenisAyi.odenmis; if (!musteri || qaliq <= 0.01) { alert("Bu ay üçün borc yoxdur və ya tam ödənilib."); return; }; document.getElementById('modalMusteriAdi').textContent = getFullName(musteri); document.getElementById('modalMehsulAdi').textContent = faktura.mehsulAdi; document.getElementById('modalAyliqOdenis').textContent = qaliq.toFixed(2); document.getElementById('odenilenMebleg').value = qaliq.toFixed(2); document.getElementById('modalMusteriId').value = musteriId; document.getElementById('modalFakturaId').value = fakturaId; document.getElementById('modalOdenisAyIndex').value = ayIndex; document.getElementById('odenisUsulu').value = 'Nağd'; document.getElementById('mixedPaymentDiv').style.display = 'none'; document.getElementById('odenilenMebleg').readOnly = false; document.getElementById('odenisKartMebleg').value = 0; document.getElementById('odenisNagdMebleg').value = 0; document.getElementById('odenisModal').style.display = 'block'; }
        function openOdenisTarixcesiModal(musteriId, fakturaId, isSimpleView = false) { const musteri = musteriler.find(m => m.id === musteriId); const faktura = musteri.fakturalar.find(f => f.fakturaId === fakturaId); if (!musteri || !faktura || faktura.tip !== 'kredit' || !faktura.odenisQrafiki) { alert("Bu faktura üçün kredit ödəniş qrafiki tapılmadı."); return; } document.getElementById('tarixceMusteriAdi').textContent = `${getFullName(musteri)} (${musteri.musteriKodu})`; document.getElementById('tarixceMehsulAdi').textContent = faktura.mehsulAdi; const thead = document.getElementById('tarixceCedveliHead'); const tbody = document.getElementById('tarixceCedveliBody'); const modalTitle = document.getElementById('tarixceModalTitle'); const printBtn = document.getElementById('tarixce-print-btn'); tbody.innerHTML = ''; if (isSimpleView) { modalTitle.innerHTML = '<i class="fas fa-calendar-alt"></i> Ödəniş Cədvəli'; thead.innerHTML = '<th>№</th><th>Ödəniş Tarixi</th><th>Aylıq Məbləğ</th><th>Status</th>'; printBtn.style.display = 'inline-block'; } else { modalTitle.innerHTML = '<i class="fas fa-history"></i> Ödəniş Qrafiki'; thead.innerHTML = '<th>№</th><th>Ödəniş Tarixi</th><th>Aylıq Məbləğ</th><th>Ödənilib</th><th>Qalıq</th><th>Status</th>'; printBtn.style.display = 'none'; } faktura.odenisQrafiki.forEach((ay) => { const qaliq = ay.odenmeli - ay.odenmis; let statusText, statusClass; if (qaliq <= 0.01) { statusText = "Ödənilib"; statusClass = "paid-row"; } else if (ay.odenmis > 0) { statusText = "Qismən Ödənilib"; statusClass = "partially-paid-row"; } else { statusText = getStatus(ay.tarix).statusText; statusClass = ''; } const tr = document.createElement('tr'); tr.className = statusClass; if (isSimpleView) { tr.innerHTML = `<td>${ay.ay}</td><td>${new Date(ay.tarix).toLocaleDateString('az-AZ')}</td><td>${ay.odenmeli.toFixed(2)}</td><td>${statusText}</td>`; } else { let odenisDetallari = ''; const allOdenisler = ay.odenisler || []; if(allOdenisler.length > 0){ odenisDetallari += '<ul>'; allOdenisler.forEach(o => { const meblegText = o.usul === 'Kart/Nağd' ? `<b>${o.mebleg.toFixed(2)} AZN</b> (K:${o.meblegKart.toFixed(2)}, N:${o.meblegNagd.toFixed(2)})` : `<b>${o.mebleg.toFixed(2)} AZN</b>`; odenisDetallari += `<li>${new Date(o.tarix).toLocaleString('az-AZ', {dateStyle: 'short', timeStyle: 'short'})} - ${meblegText}<div style="float: right;"><button class="action-btn edit-btn edit-payment-btn" data-musteri-id="${musteriId}" data-faktura-id="${fakturaId}" data-odenis-id="${o.id}" title="Düzəliş et"><i class="fas fa-edit"></i></button><button class="action-btn print-receipt-btn" data-musteri-id="${musteriId}" data-faktura-id="${fakturaId}" data-odenis-id="${o.id}" title="Çeki çap et"><i class="fas fa-print"></i></button></div></li>`; }); odenisDetallari += '</ul>'; } else { odenisDetallari = ay.odenmis > 0 ? `${ay.odenmis.toFixed(2)} AZN (əvvəlki ödənişdən transfer)` : '---' ; } tr.innerHTML = `<td>${ay.ay}</td><td>${new Date(ay.tarix).toLocaleDateString('az-AZ')}</td><td>${ay.odenmeli.toFixed(2)}</td><td>${odenisDetallari}</td><td><b>${qaliq < 0.01 ? '0.00' : qaliq.toFixed(2)}</b></td><td>${statusText}</td>`; } tbody.appendChild(tr); }); document.getElementById('odenisTarixcesiModal').style.display = 'block'; }
        function openDetailsModal(id) { const musteri = musteriler.find(m => m.id === id); if (!musteri) return; document.getElementById('detailsMusteriKodu').textContent = musteri.musteriKodu || '---'; document.getElementById('detailsAdSoyad').textContent = getFullName(musteri); document.getElementById('detailsCins').textContent = musteri.cins || '---'; document.getElementById('detailsFinKod').textContent = musteri.finKod || '---'; document.getElementById('detailsVesiqe').textContent = musteri.vesiqeSeria || '---'; document.getElementById('detailsNomreler').textContent = (musteri.nomreler || []).join(', '); const tbody = document.getElementById('fakturaTarixcesiBody'); tbody.innerHTML = ''; if (musteri.fakturalar && musteri.fakturalar.length > 0) { musteri.fakturalar.forEach(faktura => { let meblegInfo = ''; let emeliyyatBtn = ''; if (faktura.tip === 'kredit') { const qaliqBorc = getFakturaQaliqBorc(faktura); meblegInfo = `Qalıq: <b>${qaliqBorc.toFixed(2)} AZN</b>`; emeliyyatBtn = `<button class="action-btn details-btn" data-musteri-id="${id}" data-faktura-id="${faktura.fakturaId}">Cədvələ Bax</button>`; } else { meblegInfo = `${faktura.mebleg.toFixed(2)} AZN`; emeliyyatBtn = `<button class="action-btn print-receipt-btn" data-musteri-id="${id}" data-faktura-id="${faktura.fakturaId}"><i class="fas fa-print"></i> Qəbz</button>`; } const tr = `<tr><td>${faktura.fakturaId}</td><td>${new Date(faktura.tarix).toLocaleDateString('az-AZ')}</td><td><span class="status-indicator ${faktura.tip === 'kredit' ? 'status-kredit' : 'status-nagd'}"></span> ${faktura.tip.toUpperCase()}</td><td>${faktura.mehsulAdi || faktura.mehsul}</td><td>${meblegInfo}</td><td>${emeliyyatBtn}</td></tr>`; tbody.innerHTML += tr; }); } else { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Müştərinin faktura tarixçəsi boşdur.</td></tr>'; } document.getElementById('detailsModal').style.display = 'block'; }
        function openEditModal(id) { const musteri = musteriler.find(m => m.id === id); if (!musteri) return; document.getElementById('editMusteriId').value = musteri.id; document.getElementById('editAd').value = musteri.ad; document.getElementById('editSoyad').value = musteri.soyad; document.getElementById('editAtaAdi').value = musteri.ataAdi; document.getElementById('editCins').value = musteri.cins || 'Kişi'; document.getElementById('editFinKod').value = musteri.finKod; const [seria, ...nomreParts] = (musteri.vesiqeSeria || '').split(' '); const nomre = nomreParts.join(''); document.getElementById('editVesiqeSeria').value = seria || 'AZE'; document.getElementById('editVesiqeNomre').value = nomre || ''; document.getElementById('editMobil1').value = (musteri.nomreler || [])[0] || ''; document.getElementById('editMobil2').value = (musteri.nomreler || [])[1] || ''; document.getElementById('editMobil3').value = (musteri.nomreler || [])[2] || ''; document.getElementById('editModal').style.display = 'block'; }
        function openCekModal(musteri, faktura, odenis) { document.getElementById('cekSatici').textContent = magazaAdi; document.getElementById('cekId').textContent = odenis.id; document.getElementById('cekTarix').textContent = new Date(odenis.tarix || Date.now()).toLocaleString('az-AZ'); document.getElementById('cekMusteriAdi').textContent = `${getFullName(musteri)} (${musteri.musteriKodu})`; document.getElementById('cekMehsulAdi').textContent = faktura.mehsulAdi; document.getElementById('cekOdenenMebleg').textContent = odenis.mebleg.toFixed(2); document.getElementById('cekOdenisUsulu').textContent = odenis.usulText || odenis.usul; document.getElementById('cekFakturaQaliqBorc').textContent = Math.max(0, getFakturaQaliqBorc(faktura)).toFixed(2); document.getElementById('cekUmumiQaliqBorc').textContent = Math.max(0, getMusteriUmumiQaliqBorc(musteri)).toFixed(2); document.getElementById('cekModal').style.display = 'block'; }
        function openMuqavileModal(data) { const { customer, faktura } = data; document.getElementById('muqavileSatici').textContent = magazaAdi; document.getElementById('muqavileTarix').textContent = new Date(faktura.tarix).toLocaleDateString('az-AZ'); document.getElementById('muqavileMusteriAdi').textContent = getFullName(customer); document.getElementById('muqavileMusteriKodu').textContent = customer.musteriKodu || 'Təyin olunacaq'; document.getElementById('muqavileFinKod').textContent = customer.finKod; document.getElementById('muqavileVesiqe').textContent = customer.vesiqeSeria; document.getElementById('muqavileMehsul').textContent = faktura.mehsulAdi; document.getElementById('muqavileKateqoriya').textContent = faktura.mehsulKateqoriya; document.getElementById('muqavileNagdQiymet').textContent = faktura.nagdQiymet.toFixed(2); document.getElementById('muqavileKreditQiymeti').textContent = faktura.kreditQiymeti.toFixed(2); document.getElementById('muqavileIlkinOdenis').textContent = faktura.ilkinOdenis.toFixed(2); document.getElementById('muqavileKreditMuddeti').textContent = faktura.kreditMuddeti; const ayliq = faktura.odenisQrafiki[0].odenmeli; document.getElementById('muqavileAyliqOdenis').textContent = ayliq.toFixed(2); document.getElementById('muqavileIlkOdenisTarixi').textContent = new Date(faktura.odenisQrafiki[0].tarix).toLocaleDateString('az-AZ'); const qrafikBody = document.getElementById('muqavileQrafikBody'); qrafikBody.innerHTML = ''; faktura.odenisQrafiki.forEach(ay => { qrafikBody.innerHTML += `<tr><td>${ay.ay}</td><td>${new Date(ay.tarix).toLocaleDateString('az-AZ')}</td><td>${ay.odenmeli.toFixed(2)}</td><td>Gözləmədə</td></tr>`; }); document.getElementById('muqavileModal').style.display = 'block'; document.getElementById('confirmMuqavileBtn').disabled = false; document.getElementById('confirmMuqavileBtn').innerHTML = '<i class="fas fa-check"></i> Təsdiqlə və Yadda Saxla'; }
        function getFakturaQaliqBorc(faktura) { if (!faktura || faktura.tip !== 'kredit' || !faktura.odenisQrafiki) return 0; const umumiBorc = faktura.odenisQrafiki.reduce((acc, curr) => acc + curr.odenmeli, 0); const umumiOdenilmis = faktura.odenisQrafiki.reduce((acc, curr) => acc + curr.odenmis, 0); return umumiBorc - umumiOdenilmis; }
        function getMusteriUmumiQaliqBorc(musteri) { if (!musteri.fakturalar || musteri.fakturalar.length === 0) return 0; return musteri.fakturalar.reduce((total, faktura) => total + getFakturaQaliqBorc(faktura), 0); }
        function updateDashboard() { const totalCustomersEl = document.getElementById('total-customers'); if (!totalCustomersEl) return; const aktivMusteriler = musteriler.filter(m => getMusteriUmumiQaliqBorc(m) > 0.01); document.getElementById('total-customers').textContent = aktivMusteriler.length; const totalDebt = aktivMusteriler.reduce((acc, m) => acc + getMusteriUmumiQaliqBorc(m), 0); document.getElementById('total-debt').textContent = `${Math.max(0, totalDebt).toFixed(2)} AZN`; const overdue = aktivMusteriler.filter(m => { return (m.fakturalar || []).some(f => { if (f.tip !== 'kredit' || !f.odenisQrafiki) return false; const novbetiOdenisAyi = f.odenisQrafiki.find(ay => (ay.odenmeli - ay.odenmis) > 0.01); return novbetiOdenisAyi && getStatus(novbetiOdenisAyi.tarix).statusCode < 0; }); }).length; document.getElementById('overdue-payments').textContent = overdue; const thisMonth = new Date().getMonth(); const thisYear = new Date().getFullYear(); const paidThisMonth = musteriler.reduce((total, m) => { if (!m.fakturalar) return total; const buAyOdenisleri = m.fakturalar.reduce((fakturaTotal, f) => { if (f.tip === 'kredit' && f.odenisQrafiki) { const kreditOdenisleri = f.odenisQrafiki.flatMap(ay => ay.odenisler || []).filter(o => { const oDate = new Date(o.tarix); return oDate.getMonth() === thisMonth && oDate.getFullYear() === thisYear; }).reduce((sum, o) => sum + o.mebleg, 0); return fakturaTotal + kreditOdenisleri; } else if (f.tip === 'nagd') { const sDate = new Date(f.tarix); if (sDate.getMonth() === thisMonth && sDate.getFullYear() === thisYear) { return fakturaTotal + f.mebleg; } } return fakturaTotal; }, 0); return total + buAyOdenisleri; }, 0); document.getElementById('paid-this-month').textContent = `${paidThisMonth.toFixed(2)} AZN`; }
        function renderMusteriler() { const searchBox = document.getElementById('searchBox'); if(!searchBox) return; const searchTerm = searchBox.value.toLowerCase(); let filteredMusteriler = musteriler.filter(m => (getFullName(m).toLowerCase().includes(searchTerm)) || (m.musteriKodu && m.musteriKodu.toLowerCase().includes(searchTerm)) || (m.finKod && m.finKod.toLowerCase().includes(searchTerm)) ); const processedMusteriler = filteredMusteriler.map(m => { const umumiQaliqBorc = getMusteriUmumiQaliqBorc(m); const aktivKreditler = (m.fakturalar || []).filter(f => f.tip === 'kredit' && getFakturaQaliqBorc(f) > 0.01); let enYaxinOdenis = null; if (aktivKreditler.length > 0) { aktivKreditler.forEach(f => { if(f.odenisQrafiki) { const novbetiOdenisAyi = f.odenisQrafiki.find(ay => (ay.odenmeli - ay.odenmis) > 0.01); if (novbetiOdenisAyi) { const odenisTarixi = new Date(novbetiOdenisAyi.tarix); if (!enYaxinOdenis || odenisTarixi < new Date(enYaxinOdenis.tarix)) { enYaxinOdenis = { tarix: novbetiOdenisAyi.tarix, mebleg: novbetiOdenisAyi.odenmeli - novbetiOdenisAyi.odenmis }; } } }}); } return { ...m, fullName: getFullName(m), qaliqBorc: umumiQaliqBorc, novbetiOdenisTarixi: enYaxinOdenis ? enYaxinOdenis.tarix : '---', ayliqOdenis: enYaxinOdenis ? enYaxinOdenis.mebleg : 0, status: enYaxinOdenis ? getStatus(enYaxinOdenis.tarix).statusCode : (umumiQaliqBorc > 0.01 ? 3 : 4) }; }); if (sortState.column) { processedMusteriler.sort((a, b) => { let valA = sortState.column === 'ad' ? a.fullName : a[sortState.column]; let valB = sortState.column === 'ad' ? b.fullName : b[sortState.column]; if (typeof valA === 'string' && sortState.column !== 'novbetiOdenisTarixi') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); } if (sortState.column === 'novbetiOdenisTarixi') { valA = valA === '---' ? new Date('9999-12-31') : new Date(valA); valB = valB === '---' ? new Date('9999-12-31') : new Date(valB); } if (valA < valB) return sortState.direction === 'asc' ? -1 : 1; if (valA > valB) return sortState.direction === 'asc' ? 1 : -1; return 0; }); } document.querySelectorAll('#musteri-bazasi-sehifesi thead th').forEach(th => { th.classList.remove('sorted'); const icon = th.querySelector('.sort-icon'); if (icon) { icon.className = 'fas fa-sort sort-icon'; if (th.dataset.sort === sortState.column) { th.classList.add('sorted'); icon.className = `fas fa-sort-${sortState.direction === 'asc' ? 'up' : 'down'} sort-icon`; } } }); const musteriCedveli = document.getElementById('musteriCedveli'); musteriCedveli.innerHTML = processedMusteriler.map(musteri => { const hasActiveCredit = musteri.qaliqBorc > 0.01; let statusClass = getStatus(musteri.novbetiOdenisTarixi).statusClass; let novbetiTarix = musteri.novbetiOdenisTarixi !== '---' ? new Date(musteri.novbetiOdenisTarixi).toLocaleDateString('az-AZ') : (hasActiveCredit ? 'Bitib' : '---'); if (!hasActiveCredit && (musteri.fakturalar || []).length > 0) { statusClass = 'status-nagd'; } return `<tr data-id="${musteri.id}"><td><span class="status-indicator ${statusClass}" title="${getStatus(musteri.novbetiOdenisTarixi).statusText}"></span></td><td>${musteri.fullName} <span class="customer-code">${musteri.musteriKodu}</span></td><td>${hasActiveCredit ? Math.max(0, musteri.ayliqOdenis).toFixed(2) + ' AZN' : '---'}</td><td>${hasActiveCredit ? Math.max(0, musteri.qaliqBorc).toFixed(2) + ' AZN' : '---'}</td><td>${novbetiTarix}</td><td>${hasActiveCredit ? '<button class="action-btn pay-btn" title="Ödəniş et"><i class="fas fa-dollar-sign"></i></button>' : ''}<button class="action-btn view-details-btn" title="Bax"><i class="fas fa-eye"></i></button><button class="action-btn edit-btn" title="Düzəliş et"><i class="fas fa-edit"></i></button><button class="action-btn delete-btn" title="Sil"><i class="fas fa-trash-alt"></i></button></td></tr>`; }).join(''); if (processedMusteriler.length === 0) { musteriCedveli.innerHTML = `<tr><td colspan="6" style="text-align:center;">Müştəri tapılmadı.</td></tr>`; } }
        function getStatus(novbetiOdenis) { if (!novbetiOdenis || novbetiOdenis === '---') return { statusClass: 'status-normal', statusCode: 3, statusText: 'Normal' }; const buGun = new Date(); const odenisTarixi = new Date(novbetiOdenis); buGun.setHours(0,0,0,0); odenisTarixi.setHours(0,0,0,0); const ferqGun = Math.ceil((odenisTarixi - buGun) / (1000 * 3600 * 24)); if (ferqGun < 0) return { statusClass: 'status-gecikir', statusCode: -1, statusText: 'Gecikir' }; if (ferqGun === 0) return { statusClass: 'status-bugun', statusCode: 0, statusText: 'Bu gün' }; if (ferqGun <= 5) return { statusClass: 'status-yaxinlasir', statusCode: 1, statusText: 'Yaxınlaşır' }; return { statusClass: 'status-normal', statusCode: 2, statusText: 'Normal' }; }

        async function initializeApp() {
            document.getElementById('content-area').innerHTML = `<h1><i class="fas fa-spinner fa-spin"></i> Məlumatlar yüklənir...</h1><p>Zəhmət olmasa, gözləyin.</p>`;
            
            if (GAS_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE' || !GAS_URL) {
                document.getElementById('content-area').innerHTML = `<h1><i class="fas fa-exclamation-triangle"></i> Konfiqurasiya Xətası</h1><p>Zəhmət olmasa, HTML faylının içindəki JavaScript kodunda <b>GAS_URL</b> dəyişənini öz Google Apps Script URL-iniz ilə əvəz edin.</p>`;
                return;
            }

            const data = await api_call('getAllData');
            
            if (data) {
                magazaAdi = data.settings.magazaAdi || 'Mağaza Adı';
                passwords = data.settings.passwords || { delete: "1234", edit: "1234" };
                
                // <<< DÜZƏLİŞ BURADADIR: Axtarışın düzgün işləməsi üçün `nomreler` string-ini array-ə çeviririk >>>
                musteriler = (data.musteriler || []).map(musteri => {
                    // Əgər `nomreler` string-dirsə və boş deyilsə, onu vergüllə bölüb array-ə çeviririk
                    if (musteri.nomreler && typeof musteri.nomreler === 'string') {
                        musteri.nomreler = musteri.nomreler.split(',');
                    } 
                    // Əgər nomreler yoxdursa və ya başqa tipdirsə, boş array təyin edirik ki, xəta çıxmasın
                    else if (!Array.isArray(musteri.nomreler)) {
                        musteri.nomreler = [];
                    }
                    return musteri;
                });
                
                updateContent('idarə-paneli-sehifesi');
                document.querySelector('.submenu-item[data-content="idarə-paneli-sehifesi"]').classList.add('active');
            } else {
                 document.getElementById('content-area').innerHTML = `<h1><i class="fas fa-times-circle"></i> Xəta</h1><p>Məlumatları yükləmək mümkün olmadı. İnternet bağlantınızı yoxlayın və ya Google Apps Script-in düzgün nəşr olunduğundan əmin olun.</p>`;
            }
        }

        // Proqramı işə salırıq
        initializeApp();

    });
    </script>
</body>
</html>
