<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kredit İdarəetmə Sistemi (v4.0 - Yekun Stabil)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* CSS stilləri olduğu kimi qalır */
        :root { --primary-color: #4a90e2; --secondary-color: #f5a623; --danger-color: #d0021b; --success-color: #7ed321; --info-color: #4abde2; --dark-color: #2c3e50; --dark-color-lighter: #34495e; --light-color: #ecf0f1; --background-color: #f4f7f6; --text-color: #333; --border-color: #e0e0e0; --shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { display: flex; background-color: var(--background-color); overflow-x: hidden; }
        .sidebar { width: 280px; height: 100vh; background: linear-gradient(180deg, var(--dark-color) 0%, #1c2833 100%); color: var(--light-color); display: flex; flex-direction: column; padding: 20px 0; box-shadow: var(--shadow); position: fixed; left: 0; top: 0; z-index: 100; }
        .main-content { flex-grow: 1; margin-left: 280px; padding: 30px; overflow-y: auto; height: 100vh; }
        .page { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Digər CSS qaydaları qısaldılıb... Tam versiya əvvəlki kimidir */
    </style>
</head>
<body>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // ... (Naviqasiya, contentMap və digər ilkin quraşdırma kodları olduğu kimi qalır)

        // !!! VACİB: Bu sətri öz unikal URL-iniz ilə əvəz etməyi unutmayın!
        const GAS_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE'; 

        let musteriler = [];
        let magazaAdi = 'Mağaza Adı';
        let passwords = { delete: "1234", edit: "1234" };
        
        // ... (digər qlobal dəyişənlər)

        async function api_call(action, data = {}) {
            // ... (api_call funksiyası olduğu kimi qalır)
        }

        function getFullName(musteri) {
            if (!musteri) return '';
            return `${musteri.ad || ''} ${musteri.soyad || ''} ${musteri.ataAdi || ''}`.trim();
        }

        // <<< DÜZƏLİŞ #1 BURADADIR >>>
        // "Axtar" düyməsinin stabil işləməsi üçün yenidən yazılmış funksiya
        function handleKreditMusteriSearch() {
            const searchTerm = document.getElementById('kreditMusteriAxtarInput').value.toLowerCase().trim();
            const neticelerContainer = document.getElementById('kreditMusteriAxtarNeticeleri');
            const cedvelBody = document.getElementById('kreditMusteriAxtarCedveli');
            
            cedvelBody.innerHTML = ''; // Hər axtarışdan əvvəl köhnə nəticələri təmizləyirik

            if (searchTerm.length < 2) {
                neticelerContainer.style.display = 'none';
                return;
            }

            const tapilanlar = musteriler.filter(m => {
                const fullName = getFullName(m).toLowerCase();
                const musteriKodu = m.musteriKodu ? String(m.musteriKodu).toLowerCase() : '';
                const finKod = m.finKod ? m.finKod.toLowerCase() : '';
                const nomrelerVar = Array.isArray(m.nomreler) && m.nomreler.some(n => n && n.includes(searchTerm));

                return fullName.includes(searchTerm) || musteriKodu.includes(searchTerm) || finKod.includes(searchTerm) || nomrelerVar;
            });

            if (tapilanlar.length > 0) {
                tapilanlar.forEach(musteri => {
                    const nomrelerStr = Array.isArray(musteri.nomreler) ? musteri.nomreler.join(', ') : '';
                    const tr = `<tr>
                        <td>${getFullName(musteri)} <span class="customer-code">${musteri.musteriKodu}</span></td>
                        <td>${musteri.finKod || '---'}</td>
                        <td>${nomrelerStr}</td>
                        <td><button type="button" class="action-btn select-customer-btn" data-id="${musteri.id}">Seç</button></td>
                    </tr>`;
                    cedvelBody.innerHTML += tr;
                });
            } else {
                cedvelBody.innerHTML = `<tr><td colspan="4" style.align='center'>Müştəri tapılmadı.</td></tr>`;
            }
            neticelerContainer.style.display = 'block';
        }

        // DÜZƏLİŞ #2-nin TƏSİR ETDİYİ FUNKSİYA
        // Bu funksiyanın özündə dəyişiklik yoxdur, amma artıq düzgün işləyəcək,
        // çünki Apps Script tərəfi düzgün yenilənmiş məlumatı qaytaracaq.
        async function processPayment() { 
            const id = parseInt(document.getElementById('modalMusteriId').value); 
            const fakturaId = document.getElementById('modalFakturaId').value; 
            const ayIndex = parseInt(document.getElementById('modalOdenisAyIndex').value);
            const odenilenMebleg = parseFloat(document.getElementById('odenilenMebleg').value); 
            const odenisUsulu = document.getElementById('odenisUsulu').value; 
            
            const yeniOdenis = { id: "Q" + Date.now(), tarix: new Date().toISOString(), mebleg: odenilenMebleg, usul: odenisUsulu }; 
            if(odenisUsulu === 'Kart/Nağd') { 
                const kartMebleg = parseFloat(document.getElementById('odenisKartMebleg').value) || 0; 
                const nagdMebleg = parseFloat(document.getElementById('odenisNagdMebleg').value) || 0; 
                if(Math.abs((kartMebleg + nagdMebleg) - odenilenMebleg) > 0.01){ alert('Məbləğlər düzgün deyil!'); return; } 
                yeniOdenis.meblegKart = kartMebleg; yeniOdenis.meblegNagd = nagdMebleg; 
                yeniOdenis.usulText = `Kart (${kartMebleg.toFixed(2)}) + Nağd (${nagdMebleg.toFixed(2)})`; 
            } 
            
            const result = await api_call('addPayment', { musteriId: id, fakturaId, ayIndex, odenisData: yeniOdenis });

            if (result && result.updatedFaktura) {
                const musteriIndex = musteriler.findIndex(m => m.id === id);
                if (musteriIndex > -1) {
                    const fakturaIndex = musteriler[musteriIndex].fakturalar.findIndex(f => f.fakturaId === fakturaId);
                    if (fakturaIndex > -1) {
                        // Lokal məlumatı serverdən gələn tam yenilənmiş məlumatla əvəz edirik
                        musteriler[musteriIndex].fakturalar[fakturaIndex] = result.updatedFaktura;
                    }
                }
                
                document.getElementById('odenisModal').style.display = 'none'; 
                const musteri = musteriler[musteriIndex];
                openCekModal(musteri, result.updatedFaktura, yeniOdenis);
                
                // UI-ni yeniləyirik
                updateDashboard();
                // Aktiv səhifə "Müştəri Bazası"dırsa, cədvəli yeniləyirik
                if (document.getElementById('musteri-bazasi-sehifesi')) {
                    renderMusteriler();
                }
            }
        }
        
        // ... (Qalan bütün digər JavaScript funksiyaları olduğu kimi qalır)

        async function initializeApp() {
            // ... (Başlatma funksiyası olduğu kimi qalır)
        }

        initializeApp();
    });
    </script>
</body>
</html>
