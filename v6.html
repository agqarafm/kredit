<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satış İdarəetmə Sistemi</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');
        :root{--primary-color:#4a90e2;--secondary-color:#50e3c2;--background-color:#f4f7fc;--text-color:#333;--card-bg:#ffffff;--shadow:0 4px 15px rgba(0,0,0,0.08);--border-radius:12px}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Montserrat',sans-serif;background-color:var(--background-color);color:var(--text-color);display:flex;align-items:center;justify-content:center;min-height:100vh;overflow:hidden}
        #login-screen{display:none;background:var(--card-bg);padding:40px;border-radius:var(--border-radius);box-shadow:var(--shadow);text-align:center;width:100%;max-width:400px;animation:fadeIn .5s ease-in-out}
        #login-screen h1{color:var(--primary-color);margin-bottom:25px;font-weight:700}
        .input-group{margin-bottom:20px;text-align:left}
        .input-group label{display:block;margin-bottom:8px;font-weight:500;font-size:14px}
        .input-group input{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:8px;font-size:16px;transition:border-color .3s}
        .input-group input:focus{outline:none;border-color:var(--primary-color)}
        .btn{background:linear-gradient(45deg,var(--primary-color),var(--secondary-color));color:#fff;border:none;padding:14px 20px;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600;width:100%;transition:transform .2s,box-shadow .3s}
        .btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(74,144,226,.4)}
        #app-screen{width:100%;height:100vh;max-width:1400px;max-height:900px;background:var(--card-bg);border-radius:var(--border-radius);box-shadow:var(--shadow);display:none;flex-direction:row;overflow:hidden;animation:zoomIn .5s ease}
        .sidebar{width:240px;background-color:#34495e;color:#fff;padding:20px;display:flex;flex-direction:column;flex-shrink:0}
        .sidebar-header{text-align:center;margin-bottom:40px}
        .sidebar-header h2{font-size:24px;margin-bottom:5px;color:var(--secondary-color)}
        .sidebar-header p{font-size:14px;opacity:.8}
        .nav-menu{list-style:none;flex-grow:1}
        .nav-menu li{margin-bottom:10px}
        .nav-menu a{color:#fff;text-decoration:none;display:flex;align-items:center;padding:15px;border-radius:8px;transition:background-color .3s,color .3s;font-weight:500}
        .nav-menu a i{margin-right:15px;font-size:20px;width:25px;text-align:center}
        .nav-menu a.active,.nav-menu a:hover{background-color:rgba(255,255,255,.1)}
        .main-content{flex-grow:1;padding:30px;overflow-y:auto}
        .page{display:none;animation:slideUp .6s ease-out}
        .page.active{display:block}
        .page-header{font-size:28px;font-weight:700;margin-bottom:25px;color:var(--primary-color)}
        #sale-form{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;background:#fdfdfd;padding:25px;border-radius:var(--border-radius);border:1px solid #eee}
        .form-group{display:flex;flex-direction:column}
        .form-group label{margin-bottom:8px;font-weight:600}
        .form-group input,.form-group select{padding:12px;border-radius:8px;border:1px solid #ccc;font-size:15px}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary-color)}
        .payment-section{grid-column:1/-1;border-top:1px solid #eee;margin-top:15px;padding-top:20px}
        .payment-section h3{margin-bottom:15px}
        .payment-inputs{display:flex;gap:20px;align-items:center}
        .payment-inputs .form-group{flex-grow:1}
        #btn-complete-sale{grid-column:1/-1;padding:15px;font-size:18px}
        .table-container{background-color:var(--card-bg);border-radius:var(--border-radius);box-shadow:var(--shadow);overflow:hidden}
        table{width:100%;border-collapse:collapse}
        td,th{padding:15px;text-align:left;border-bottom:1px solid #eee}
        thead{background-color:#f8f9fa}
        th{font-weight:600;color:var(--primary-color)}
        tbody tr:hover{background-color:#f4f7fc}
        .search-bar{margin-bottom:20px;width:100%;max-width:400px;position:relative}
        .search-bar input{width:100%;padding:12px 12px 12px 40px;border-radius:8px;border:1px solid #ccc}
        .search-bar i{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#aaa}
        .kassa-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}
        .summary-card{background:linear-gradient(135deg,#4a90e2,#50e3c2);color:#fff;padding:25px;border-radius:var(--border-radius);text-align:center;box-shadow:0 8px 25px rgba(0,0,0,.1)}
        .summary-card i{font-size:40px;margin-bottom:15px}
        .summary-card h3{font-size:18px;margin-bottom:10px;text-transform:uppercase}
        .summary-card p{font-size:32px;font-weight:700}
        #receipt-to-print{display:none}
        @media print{body>*:not(#receipt-to-print){display:none!important}#receipt-to-print{display:block!important;position:absolute;top:0;left:0;width:100%}}
        @keyframes fadeIn{0%{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
        @keyframes zoomIn{0%{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
        @keyframes slideUp{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .loader-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.7);display:flex;justify-content:center;align-items:center;z-index:9999}
        .loader{border:8px solid #f3f3f3;border-radius:50%;border-top:8px solid var(--primary-color);width:60px;height:60px;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>

    <div id="loader-overlay" class="loader-overlay"><div class="loader"></div></div>
    <div id="login-screen"><h1 id="login-store-name">Mağaza Adı</h1><form id="login-form"><div class="input-group"><label for="store-name">Mağaza Adı</label><input type="text" id="store-name" required></div><div class="input-group"><label for="username">Login</label><input type="text" id="username" required></div><div class="input-group"><label for="password">Parol</label><input type="password" id="password" required></div><button type="submit" class="btn">Daxil Ol</button></form></div>
    <div id="app-screen"><nav class="sidebar"><div class="sidebar-header"><h2 id="app-store-name">Mağaza</h2><p>İdarəetmə Paneli</p></div><ul class="nav-menu"><li><a href="#" data-page="page-satis" class="nav-link active"><i class="bi bi-cart-plus-fill"></i>Satış</a></li><li><a href="#" data-page="page-kassa" class="nav-link"><i class="bi bi-calculator-fill"></i>Kassa gün sonu</a></li><li><a href="#" data-page="page-satislar" class="nav-link"><i class="bi bi-receipt-cutoff"></i>Satışlar</a></li><li><a href="#" data-page="page-tenzimlemeler" class="nav-link"><i class="bi bi-gear-fill"></i>Tənzimləmələr</a></li></ul></nav><main class="main-content"><div id="page-satis" class="page active"><h2 class="page-header">Yeni Satış</h2><form id="sale-form"><div class="form-group"><label for="customer-name">Müştəri Ad/Soyad</label><input type="text" id="customer-name" required></div><div class="form-group"><label for="customer-phone">Telefon Nömrəsi</label><input type="tel" id="customer-phone" required></div><div class="form-group"><label for="product-name">Məhsulun Adı</label><input type="text" id="product-name" required></div><div class="form-group"><label for="product-category">Kateqoriya</label><select id="product-category" required><option value="Böyük məişət">Böyük məişət</option><option value="Kiçik məişət">Kiçik məişət</option><option value="Digər">Digər</option></select></div><div class="form-group" style="grid-column:1/-1"><label for="total-price">Ümumi Qiymət (AZN)</label><input type="number" id="total-price" min="0" step=".01" required></div><div class="payment-section"><h3>Ödəniş Növü</h3><div class="payment-inputs"><div class="form-group"><label for="cash-payment">Nağd Ödəniş</label><input type="number" id="cash-payment" min="0" step=".01" value="0"></div><div class="form-group"><label for="card-payment">Kartla Ödəniş</label><input type="number" id="card-payment" min="0" step=".01" value="0"></div></div></div><button type="submit" id="btn-complete-sale" class="btn">Satışı Tamamla</button></form></div><div id="page-kassa" class="page"><h2 class="page-header">Kassa - Günün Yekunu (<span id="today-date"></span>)</h2><div class="kassa-summary"><div class="summary-card"><i class="bi bi-cash-coin"></i><h3>Nağd Mədaxil</h3><p id="total-cash">0.00 AZN</p></div><div class="summary-card"><i class="bi bi-credit-card-2-front-fill"></i><h3>Kart Mədaxil</h3><p id="total-card">0.00 AZN</p></div><div class="summary-card" style="background:linear-gradient(135deg,#5d6d7e,#34495e)"><i class="bi bi-graph-up-arrow"></i><h3>Ümumi Mədaxil</h3><p id="total-overall">0.00 AZN</p></div></div></div><div id="page-satislar" class="page"><h2 class="page-header">Satışlar Tarixçəsi</h2><div class="search-bar"><i class="bi bi-search"></i><input type="text" id="sales-search" placeholder="Faktura nömrəsi, müştəri adı ilə axtar..."></div><div class="table-container"><table id="sales-table"><thead><tr><th>Faktura №</th><th>Tarix</th><th>Müştəri</th><th>Məhsul</th><th>Məbləğ</th><th>Ödəniş</th><th></th></tr></thead><tbody></tbody></table></div></div><div id="page-tenzimlemeler" class="page"><h2 class="page-header">Sistem Tənzimləmələri</h2><form id="settings-form" style="max-width:500px;display:flex;flex-direction:column;gap:20px"><div class="form-group"><label for="setting-store-name">Mağaza Adı</label><input type="text" id="setting-store-name" required></div><div class="form-group"><label for="setting-username">Sistemə Giriş Logini</label><input type="text" id="setting-username" required></div><div class="form-group"><label for="setting-password">Sistemə Giriş Parolu</label><input type="password" id="setting-password" required></div><button type="submit" class="btn">Yadda Saxla</button></form></div></main></div>
    <div id="receipt-to-print"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxl1icKpFvE2IO51zhATk7XQUbysJx8grkPN9EClWcwVtMsycyVZC35Cq4JuIsavGs5_A/exec';
            const SETTINGS_CACHE_KEY = 'posAppSettings';

            const loginScreen=document.getElementById('login-screen'),appScreen=document.getElementById('app-screen'),loginForm=document.getElementById('login-form'),saleForm=document.getElementById('sale-form'),settingsForm=document.getElementById('settings-form'),loader=document.getElementById('loader-overlay');
            let allSalesData=[],settings={};

            // --- KRITIK DƏYİŞİKLİK: Başlanğıc funksiyası yeniləndi ---
            function initializeApp() {
                const cachedSettings = localStorage.getItem(SETTINGS_CACHE_KEY);
                
                if (cachedSettings) {
                    // Əgər keşdə məlumat varsa, dərhal göstər
                    settings = JSON.parse(cachedSettings);
                    applySettings();
                    loginScreen.style.display = 'block';
                    hideLoader();
                    // Arxa planda yeniləməni yoxla
                    syncSettingsWithSheet();
                } else {
                    // Əgər keş boşdursa, serverdən yüklə (ilk açılış)
                    showLoader();
                    syncSettingsWithSheet(true); // `true` parametri loader-i gizlətmək üçün
                }
            }

            // Arxa planda tənzimləmələri Google Sheet ilə sinxronlaşdıran funksiya
            async function syncSettingsWithSheet(hideLoaderOnFinish = false) {
                try {
                    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getSettings`);
                    const result = await response.json();
                    if (result.success) {
                        settings = result.data;
                        localStorage.setItem(SETTINGS_CACHE_KEY, JSON.stringify(settings));
                        applySettings(); // UI-nı yenilənmiş məlumatlarla təzələ
                    }
                } catch (error) {
                    console.error("Tənzimləmələri sinxronlaşdırmaq mümkün olmadı:", error);
                } finally {
                    if (hideLoaderOnFinish) {
                        loginScreen.style.display = 'block';
                        hideLoader();
                    }
                }
            }
            // --- DƏYİŞİKLİYİN SONU ---

            function applySettings(){document.getElementById("login-store-name").textContent=settings.storeName||"Mağaza";document.getElementById("store-name").value=settings.storeName||"";document.getElementById("username").value=settings.username||"admin";document.getElementById("app-store-name").textContent=settings.storeName||"Mağaza";document.getElementById("setting-store-name").value=settings.storeName||"";document.getElementById("setting-username").value=settings.username||"";document.getElementById("setting-password").value=settings.password||""}
            loginForm.addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("store-name").value,o=document.getElementById("username").value,a=document.getElementById("password").value;o===settings.username&&a===settings.password&&t===settings.storeName?(loginScreen.style.display="none",appScreen.style.display="flex",fetchSalesData()):Swal.fire({icon:"error",title:"Xəta",text:"Mağaza adı, login və ya parol yanlışdır!"})});
            const navLinks=document.querySelectorAll(".nav-link");navLinks.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const o=e.getAttribute("data-page");document.querySelectorAll(".page").forEach(e=>e.classList.remove("active")),document.getElementById(o).classList.add("active"),navLinks.forEach(e=>e.classList.remove("active")),e.classList.add("active"),"page-kassa"===o&&updateKassa(),"page-satislar"===o&&displaySales(allSalesData)})});
            async function fetchSalesData(){showLoader();try{const e=await fetch(GOOGLE_SCRIPT_URL),t=await e.json();if(t.success)allSalesData=t.data.sort((e,t)=>new Date(t.Tarix)-new Date(e.Tarix)),displaySales(allSalesData),updateKassa();else throw new Error(t.message)}catch(e){showError("Satış məlumatları gətirilərkən xəta baş verdi: "+e.message)}finally{hideLoader()}}
            async function postData(e){showLoader();try{const t=await fetch(GOOGLE_SCRIPT_URL,{method:"POST",cache:"no-cache",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(e)});return await t.json()}catch(e){return showError("Məlumat göndərilərkən xəta baş verdi: "+e.message),{success:!1,message:e.message}}finally{hideLoader()}}
            saleForm.addEventListener("submit",async e=>{e.preventDefault();const t=parseFloat(document.getElementById("total-price").value)||0,o=parseFloat(document.getElementById("cash-payment").value)||0,a=parseFloat(document.getElementById("card-payment").value)||0;if(t!==o+a)return void Swal.fire("Xəta!","Nağd və kart ödənişlərinin cəmi ümumi qiymətə bərabər olmalıdır.","error");const n={action:"addSale",fakturaNo:generateInvoiceNumber(),musteriAdSoyad:document.getElementById("customer-name").value,musteriTelefon:document.getElementById("customer-phone").value,mehsulAdi:document.getElementById("product-name").value,kateqoriya:document.getElementById("product-category").value,umumiMebleg:t,nagdOdenis:o,kartOdenis:a},d=await postData(n);d&&d.success?(await fetchSalesData(),Swal.fire({icon:"success",title:"Satış tamamlandı!",text:`Faktura Nömrəsi: ${n.fakturaNo}`}).then(()=>{const e={...n,tarix:new Date};printReceipt(e),saleForm.reset()})):showError("Satış yadda saxlanılarkən xəta baş verdi: "+(d?d.message:"Naməlum xəta"))});
            
            // --- KRITIK DƏYİŞİKLİK: Tənzimləmələr yadda saxlananda keşi də yeniləyir ---
            settingsForm.addEventListener("submit",async e=>{e.preventDefault();
                const newSettings={storeName:document.getElementById("setting-store-name").value,username:document.getElementById("setting-username").value,password:document.getElementById("setting-password").value};
                const payload={action:"updateSettings",settings:newSettings};
                const result=await postData(payload);
                if(result&&result.success){
                    settings=newSettings;
                    localStorage.setItem(SETTINGS_CACHE_KEY, JSON.stringify(settings)); // Keşi yenilə
                    applySettings();
                    Swal.fire("Uğurlu!","Tənzimləmələr yadda saxlanıldı.","success")
                }else{
                    showError("Tənzimləmələr yadda saxlanılarkən xəta baş verdi.")
                }
            });
            // --- DƏYİŞİKLİYİN SONU ---

            function generateInvoiceNumber(){const e=new Date;return`INV-${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}-${String(e.getHours()).padStart(2,"0")}${String(e.getMinutes()).padStart(2,"0")}${String(e.getSeconds()).padStart(2,"0")}`}
            const salesTableBody=document.querySelector("#sales-table tbody"),searchInput=document.getElementById("sales-search");function displaySales(e){salesTableBody.innerHTML="",e&&0!==e.length?e.forEach(e=>{const t=document.createElement("tr"),o=new Date(e.Tarix),a=isNaN(o)?"N/A":o.toLocaleString("az-AZ");let n=[];e.NagdOdenis>0&&n.push("Nağd"),e.KartOdenis>0&&n.push("Kart"),t.innerHTML=`<td>${e.FakturaNo}</td><td>${a}</td><td>${e.MusteriAdSoyad}</td><td>${e.MehsulAdi}</td><td>${parseFloat(e.UmumiMebleg).toFixed(2)} AZN</td><td>${n.join(" + ")}</td><td><button class="btn-print-receipt" data-faktura="${e.FakturaNo}" style="background:none; border:none; cursor:pointer; color: var(--primary-color); font-size:20px;"><i class="bi bi-printer-fill"></i></button></td>`,salesTableBody.appendChild(t)}):salesTableBody.innerHTML='<tr><td colspan="7" style="text-align:center;">Heç bir satış tapılmadı.</td></tr>',document.querySelectorAll(".btn-print-receipt").forEach(e=>{e.addEventListener("click",function(){const t=this.getAttribute("data-faktura"),o=allSalesData.find(e=>e.FakturaNo===t);if(o){const e={fakturaNo:o.FakturaNo,musteriAdSoyad:o.MusteriAdSoyad,musteriTelefon:o.MusteriTelefon,mehsulAdi:o.MehsulAdi,kateqoriya:o.Kateqoriya,umumiMebleg:o.UmumiMebleg,nagdOdenis:o.NagdOdenis,kartOdenis:o.KartOdenis,tarix:new Date(o.Tarix)};printReceipt(e)}})})}
            searchInput.addEventListener("input",e=>{const t=e.target.value.toLowerCase();displaySales(allSalesData.filter(e=>e.FakturaNo.toLowerCase().includes(t)||e.MusteriAdSoyad.toLowerCase().includes(t)))});function updateKassa(){const e=new Date().toLocaleDateString("az-AZ");document.getElementById("today-date").textContent=e;let t=0,o=0;allSalesData.filter(t=>new Date(t.Tarix).toLocaleDateString("az-AZ")===e).forEach(e=>{t+=parseFloat(e.NagdOdenis)||0,o+=parseFloat(e.KartOdenis)||0}),document.getElementById("total-cash").textContent=`${t.toFixed(2)} AZN`,document.getElementById("total-card").textContent=`${o.toFixed(2)} AZN`,document.getElementById("total-overall").textContent=`${(t+o).toFixed(2)} AZN`}
            function printReceipt(e){if(!e||!e.fakturaNo)return void showError("Çap üçün məlumatlar natamamdır. Proses dayandırıldı.");const t=document.getElementById("receipt-to-print"),o=e.tarix?e.tarix:new Date,a=`<div style="width: 300px; padding: 20px; color: #000; font-family: 'Courier New', monospace;"><h2 style="text-align: center; margin-bottom: 20px;">${settings.storeName}</h2><p><strong>Faktura №:</strong> ${e.fakturaNo}</p><p><strong>Tarix:</strong> ${o.toLocaleString("az-AZ")}</p><hr style="margin: 10px 0; border-top: 1px dashed #000;"><p><strong>Müştəri:</strong> ${e.musteriAdSoyad}</p><p><strong>Telefon:</strong> ${e.musteriTelefon}</p><hr style="margin: 10px 0; border-top: 1px dashed #000;"><h3 style="text-align: center; margin-bottom: 10px;">Məhsul Məlumatları</h3><p><strong>Ad:</strong> ${e.mehsulAdi}</p><p><strong>Kateqoriya:</strong> ${e.kateqoriya}</p><hr style="margin: 10px 0; border-top: 1px dashed #000;"><p style="font-size: 18px; font-weight: bold;"><strong>ÜMUMİ MƏBLƏĞ: ${parseFloat(e.umumiMebleg).toFixed(2)} AZN</strong></p><hr style="margin: 10px 0; border-top: 1px dashed #000;"><p>Nağd Ödəniş: ${parseFloat(e.nagdOdenis).toFixed(2)} AZN</p><p>Kartla Ödəniş: ${parseFloat(e.kartOdenis).toFixed(2)} AZN</p><p style="text-align: center; margin-top: 20px;">Təşəkkür edirik!</p></div>`;t.innerHTML=a,setTimeout(()=>{window.print()},100)}
            function showLoader(){loader.style.display="flex"}
            function hideLoader(){loader.style.display="none"}
            function showError(e){Swal.fire({icon:"error",title:"Xəta",text:e})}
            initializeApp()
        });
    </script>
</body>
</html>
